// Biblioteca PAP - Single Page Application (SPA) JavaScript

const BibliotecaSPA = {
    
    // Configuraci√≥n
    config: {
        apiBaseUrl: '',
        currentPage: 'login',
        userSession: null
    },
    
    // Inicializaci√≥n
    init: function() {
        this.setupEventListeners();
        this.setupHistoryAPI();
        this.checkUserSession();
        this.initTheme();
        this.handleInitialPage();
    },
    
    // Configurar event listeners
    setupEventListeners: function() {
        // Navegaci√≥n
        $(document).on('click', '.nav-link', (e) => {
            e.preventDefault();
            const page = $(e.target).data('page');
            if (page) {
                this.navigateToPage(page);
            }
        });
        
        // Manejar enlaces con href="#p√°gina"
        $(document).on('click', 'a[href^="#"]', (e) => {
            e.preventDefault();
            const href = $(e.target).attr('href');
            const page = href.substring(1); // Remover el #
            if (page) {
                this.navigateToPage(page);
            }
        });
        
        // Login/Register toggle
        $('#showRegisterBtn').click((e) => {
            e.preventDefault();
            this.showPage('register');
        });
        
        $('#showLoginBtn').click((e) => {
            e.preventDefault();
            this.showPage('login');
        });
        
        // Logout
        $('#logoutBtn').click((e) => {
            e.preventDefault();
            this.logout();
        });
        
        // Toggle de tema
        $('#themeToggle').click((e) => {
            e.preventDefault();
            this.toggleTheme();
        });
        
        // Formularios
        $('#loginForm').on('submit', (e) => {
            e.preventDefault();
            this.handleLogin();
        });
        
        $('#registerForm').on('submit', (e) => {
            e.preventDefault();
            this.handleRegister();
        });
        
        // Toggle campos espec√≠ficos en registro
        $('#regUserType').change(function() {
            const userType = $(this).val();
            if (userType === 'BIBLIOTECARIO') {
                $('#bibliotecarioFields').show();
                $('#lectorFields').hide();
                $('#regNumeroEmpleado').prop('required', true);
                $('#regDireccion').prop('required', false);
                $('#regZona').prop('required', false);
            } else if (userType === 'LECTOR') {
                $('#bibliotecarioFields').hide();
                $('#lectorFields').show();
                $('#regNumeroEmpleado').prop('required', false);
                $('#regDireccion').prop('required', true);
                $('#regZona').prop('required', true);
            } else {
                $('#bibliotecarioFields').hide();
                $('#lectorFields').hide();
            }
        });
    },
    
    // Configurar History API para navegaci√≥n SPA
    setupHistoryAPI: function() {
        // Manejar navegaci√≥n del navegador (bot√≥n atr√°s/adelante)
        window.addEventListener('popstate', (event) => {
            const state = event.state || {};
            let page = state.page || this.getPageFromURL();
            
            // Si hay sesi√≥n activa, manejar navegaci√≥n hacia atr√°s
            if (this.config.userSession) {
                // Si no hay p√°gina espec√≠fica o es login/register, ir al dashboard
                if (!page || page === 'login' || page === 'register') {
                    page = 'dashboard';
                }
                
                // Actualizar la URL sin disparar otro popstate
                history.replaceState({ page: page }, '', this.getURLFromPage(page));
            }
            
            if (page && page !== this.config.currentPage) {
                this.config.currentPage = page;
                this.handlePageNavigation(page);
            }
        });
        
        // Configurar estado inicial
        if (!history.state) {
            const initialPage = this.getPageFromURL();
            history.replaceState({ page: initialPage }, '', this.getURLFromPage(initialPage));
        }
    },
    
    // Obtener p√°gina desde URL
    getPageFromURL: function() {
        const hash = window.location.hash.substring(1);
        const path = window.location.pathname;
        
        // Si hay sesi√≥n activa, priorizar dashboard
        if (this.config.userSession) {
            // Si hay hash, verificar que sea v√°lido
            if (hash) {
                // Verificar que no sea login/register
                if (hash === 'login' || hash === 'register') {
                    return 'dashboard';
                }
                return hash;
            }
            
            // Si no hay hash, ir al dashboard
            return 'dashboard';
        }
        
        // Usuario no logueado
        if (hash) {
            // Solo permitir login/register
            return (hash === 'login' || hash === 'register') ? hash : 'login';
        }
        
        // Si es la p√°gina principal, ir a login
        if (path === '/' || path.includes('spa.html')) {
            return 'login';
        }
        
        return 'login';
    },
    
    // Obtener URL desde p√°gina
    getURLFromPage: function(page) {
        if (page === 'login' || page === 'register') {
            return window.location.pathname;
        }
        return window.location.pathname + '#' + page;
    },
    
    // Manejar navegaci√≥n de p√°gina
    handlePageNavigation: function(page) {
        if (this.config.userSession) {
            // Usuario logueado - verificar si la p√°gina es v√°lida
            if (page === 'login' || page === 'register') {
                // Si intenta ir a login/register estando logueado, redirigir al dashboard
                this.navigateToPage('dashboard');
                return;
            }
            
            // Mostrar p√°gina correspondiente
            this.showPage(page);
            this.loadPageContent(page);
            this.updateNavigation(page);
        } else {
            // Usuario no logueado - redirigir a login
            this.showPage('login');
        }
    },
    
    // Manejar p√°gina inicial
    handleInitialPage: function() {
        const page = this.getPageFromURL();
        
        if (this.config.userSession) {
            // Usuario ya logueado - asegurar que vaya al dashboard si no hay p√°gina espec√≠fica
            const targetPage = page || 'dashboard';
            this.config.currentPage = targetPage;
            this.showPage(targetPage);
            this.loadPageContent(targetPage);
        } else {
            // Usuario no logueado - mostrar login
            this.config.currentPage = 'login';
            this.showPage('login');
        }
    },
    
    // Verificar sesi√≥n de usuario
    checkUserSession: async function() {
        console.log('üîç checkUserSession called');
        const userSession = sessionStorage.getItem('bibliotecaUserSession');
        console.log('üîç userSession from storage:', userSession);
        
        if (userSession) {
            this.config.userSession = JSON.parse(userSession);
            console.log('üîç parsed userSession:', this.config.userSession);
            
            // Verificar si la sesi√≥n es vieja y no tiene userData
            if (!this.config.userSession.userData || !this.config.userSession.userData.id) {
                console.warn('‚ö†Ô∏è Sesi√≥n vieja detectada sin userData.id, actualizando...');
                
                // Obtener datos del usuario del servidor
                const email = this.config.userSession.email;
                const userType = this.config.userSession.userType;
                
                if (email && userType) {
                    const userData = await this.getUserData(email, userType);
                    
                    if (userData && userData.id) {
                        // Actualizar la sesi√≥n con los datos completos
                        this.config.userSession.userData = userData;
                        this.config.userSession.nombre = userData.nombre;
                        this.config.userSession.apellido = userData.apellido || '';
                        this.config.userSession.nombreCompleto = `${userData.nombre} ${userData.apellido || ''}`.trim();
                        
                        // Guardar sesi√≥n actualizada
                        sessionStorage.setItem('bibliotecaUserSession', JSON.stringify(this.config.userSession));
                        console.log('‚úÖ Sesi√≥n actualizada con userData:', this.config.userSession);
                    } else {
                        console.error('‚ùå No se pudo obtener userData, forzando logout');
                        this.logout();
                        return;
                    }
                }
            }
            
            this.showAuthenticatedUI();
            this.updateNavigationForRole();
        } else {
            console.log('‚ùå No user session found in storage');
        }
    },
    
    // Manejar navegaci√≥n hacia atr√°s para usuarios logueados
    handleBackNavigation: function() {
        if (this.config.userSession) {
            // Usuario logueado - ir al dashboard
            this.navigateToPage('dashboard');
        } else {
            // Usuario no logueado - ir a login
            this.navigateToPage('login');
        }
    },
    
    // Mostrar UI autenticada
    showAuthenticatedUI: function() {
        $('#mainNavigation').show();
        // No navegar autom√°ticamente aqu√≠, se maneja en handleInitialPage
    },
    
    // Actualizar navegaci√≥n seg√∫n el rol del usuario
    updateNavigationForRole: function() {
        console.log('üîç updateNavigationForRole called');
        console.log('üîç userSession:', this.config.userSession);
        
        if (!this.config.userSession) {
            console.log('‚ùå No user session found');
            return;
        }
        
        const userType = this.config.userSession.userType;
        console.log('üîç userType:', userType);
        console.log('üîç userType type:', typeof userType);
        console.log('üîç userType === "BIBLIOTECARIO":', userType === 'BIBLIOTECARIO');
        console.log('üîç userType === "LECTOR":', userType === 'LECTOR');
        
        const isLector = userType === 'LECTOR';
        const isBibliotecario = userType === 'BIBLIOTECARIO';
        
        console.log('üîç isLector:', isLector);
        console.log('üîç isBibliotecario:', isBibliotecario);
        
        // Agregar clase al body para control CSS
        $('body').removeClass('user-type-lector user-type-bibliotecario');
        
        // Ocultar/mostrar elementos seg√∫n el rol
        if (isLector) {
            console.log('‚úÖ Setting up LECTOR navigation');
            // Agregar clase CSS para lector
            $('body').addClass('user-type-lector');
            
            // Ocultar opciones de bibliotecario
            $('.bibliotecario-only').hide();
            $('.lector-only').show();
            
            // Actualizar men√∫ de navegaci√≥n
            this.updateMainNavigationForLector();
        } else if (isBibliotecario) {
            console.log('‚úÖ Setting up BIBLIOTECARIO navigation');
            // Agregar clase CSS para bibliotecario
            $('body').addClass('user-type-bibliotecario');
            
            // Mostrar todas las opciones para bibliotecario
            $('.bibliotecario-only').show();
            $('.lector-only').show();
            
            // Actualizar men√∫ de navegaci√≥n
            this.updateMainNavigationForBibliotecario();
        } else {
            console.log('‚ùå Unknown user type:', userType);
        }
        
        // Actualizar informaci√≥n del usuario en la UI
        this.updateUserInfo();
    },
    
    // Actualizar navegaci√≥n principal para lector
    updateMainNavigationForLector: function() {
        const navHtml = `
            <div class="nav-section">
                <h4>üìö Mis Servicios</h4>
                <ul>
                    <li><a href="#dashboard" class="nav-link" data-page="dashboard">üìä Mi Dashboard</a></li>
                    <li><a href="#prestamos" class="nav-link" data-page="prestamos">üìñ Mis Pr√©stamos</a></li>
                    <li><a href="#historial" class="nav-link" data-page="historial">üìã Mi Historial</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <h4>üîç Buscar</h4>
                <ul>
                    <li><a href="#buscar-libros" class="nav-link" data-page="buscar-libros">üìö Buscar Libros</a></li>
                    <li><a href="#buscar-materiales" class="nav-link" data-page="buscar-materiales">üìÑ Buscar Materiales</a></li>
                </ul>
            </div>
        `;
        $('#mainNavigation .nav-content').html(navHtml);
    },
    
    // Actualizar navegaci√≥n principal para bibliotecario
    updateMainNavigationForBibliotecario: function() {
        const navHtml = `
            <div class="nav-section">
                <h4>üìä Gesti√≥n General</h4>
                <ul>
                    <li><a href="#dashboard" class="nav-link" data-page="dashboard">üìà Dashboard</a></li>
                    <li><a href="#reportes" class="nav-link" data-page="reportes">üìä Reportes</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <h4>üë• Gesti√≥n de Usuarios</h4>
                <ul>
                    <li><a href="#lectores" class="nav-link" data-page="lectores">üë§ Gestionar Lectores</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <h4>üìö Gesti√≥n de Materiales</h4>
                <ul>
                    <li><a href="#libros" class="nav-link" data-page="libros">üìñ Gestionar Libros</a></li>
                    <li><a href="#donaciones" class="nav-link" data-page="donaciones">üéÅ Gestionar Donaciones</a></li>
                    <li><a href="#materiales" class="nav-link" data-page="materiales">üìÑ Gestionar Materiales</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <h4>üìã Gesti√≥n de Pr√©stamos</h4>
                <ul>
                    <li><a href="#prestamos" class="nav-link" data-page="prestamos">üìö Gestionar Pr√©stamos</a></li>
                    <li><a href="#prestamos-activos" class="nav-link" data-page="prestamos-activos">‚è∞ Pr√©stamos Activos</a></li>
                    <li><a href="#devoluciones" class="nav-link" data-page="devoluciones">‚Ü©Ô∏è Devoluciones</a></li>
                </ul>
            </div>
        `;
        $('#mainNavigation .nav-content').html(navHtml);
    },
    
    // Actualizar informaci√≥n del usuario en la UI
    updateUserInfo: function() {
        if (!this.config.userSession) return;
        
        const user = this.config.userSession;
        const userInfoHtml = `
            <div class="user-info">
                <div class="user-avatar">
                    <i class="fas ${user.userType === 'BIBLIOTECARIO' ? 'fa-user-tie' : 'fa-user'}"></i>
                </div>
                <div class="user-details">
                    <div class="user-name">${user.nombreCompleto || user.nombre || user.email}</div>
                    <div class="user-role">${user.userType === 'BIBLIOTECARIO' ? 'Bibliotecario' : 'Lector'}</div>
                </div>
            </div>
        `;
        $('#userInfo').html(userInfoHtml);
    },
    
    // Obtener datos del usuario desde el servidor
    getUserData: async function(email, userType) {
        console.log('üîç Getting user data for:', email, userType);
        
        try {
            if (userType === 'LECTOR') {
                // Obtener datos del lector desde el servidor
                const response = await $.ajax({
                    url: `/lector/por-email?email=${encodeURIComponent(email)}`,
                    method: 'GET',
                    dataType: 'json'
                });
                
                console.log('üìä Respuesta getUserData:', response);
                
                if (response && response.success && response.lector) {
                    return {
                        id: response.lector.id,
                        nombre: response.lector.nombre || 'Usuario',
                        apellido: '',  // El modelo actual no tiene apellido separado
                        email: response.lector.email,
                        direccion: response.lector.direccion,
                        zona: response.lector.zona,
                        estado: response.lector.estado,
                        historialPrestamos: [],
                        prestamosActivos: 0,
                        prestamosCompletados: 0
                    };
                } else {
                    console.warn('‚ö†Ô∏è Respuesta no exitosa o sin datos de lector:', response);
                    throw new Error('No se pudo obtener datos del lector');
                }
            } else if (userType === 'BIBLIOTECARIO') {
                // Para bibliotecarios, obtener datos del servidor
                const response = await $.ajax({
                    url: `/bibliotecario/por-email?email=${encodeURIComponent(email)}`,
                    method: 'GET',
                    dataType: 'json'
                });
                
                console.log('üìä Respuesta de bibliotecario por email:', response);
                
                if (response && response.success && response.bibliotecario) {
                    return {
                        id: response.bibliotecario.id,
                        nombre: response.bibliotecario.nombre,
                        apellido: '',
                        nombreCompleto: response.bibliotecario.nombre,
                        email: response.bibliotecario.email,
                        numeroEmpleado: response.bibliotecario.numeroEmpleado,
                        historialPrestamos: [],
                        prestamosActivos: 0,
                        prestamosCompletados: 0
                    };
                } else {
                    console.warn('‚ö†Ô∏è Respuesta no exitosa o sin datos de bibliotecario:', response);
                    throw new Error('No se pudo obtener datos del bibliotecario');
                }
            }
            
            // Fallback para otros tipos de usuario
            console.warn('‚ö†Ô∏è Tipo de usuario no reconocido:', userType);
            throw new Error('Tipo de usuario no v√°lido');
        } catch (error) {
            console.error('‚ùå Error obteniendo datos del usuario:', error);
            console.error('‚ùå Stack trace:', error.stack);
            // Re-lanzar el error para que el login lo maneje
            throw error;
        }
    },
    
    // Navegar a p√°gina
    navigateToPage: function(pageName) {
        // Verificar que el usuario est√© logueado para p√°ginas protegidas
        if (pageName !== 'login' && pageName !== 'register' && !this.config.userSession) {
            this.showAlert('Debe iniciar sesi√≥n para acceder a esta p√°gina', 'warning');
            this.showPage('login');
            return;
        }
        
        // Si el usuario est√° logueado y intenta ir a login/register, redirigir al dashboard
        if (this.config.userSession && (pageName === 'login' || pageName === 'register')) {
            pageName = 'dashboard';
        }
        
        this.config.currentPage = pageName;
        
        // Actualizar URL con History API
        const url = this.getURLFromPage(pageName);
        history.pushState({ page: pageName }, '', url);
        
        this.showPage(pageName);
        this.loadPageContent(pageName);
        this.updateNavigation(pageName);
    },
    
    // Mostrar p√°gina espec√≠fica
    showPage: function(pageName) {
        // Ocultar todas las p√°ginas
        $('.page').removeClass('active').hide();
        
        // Mostrar p√°gina seleccionada
        setTimeout(() => {
            $(`#${pageName}Page`).show().addClass('active');
        }, 50);
    },
    
    // Actualizar navegaci√≥n
    updateNavigation: function(pageName) {
        $('.nav-link').removeClass('active');
        $(`.nav-link[data-page="${pageName}"]`).addClass('active');
    },
    
    // Cargar contenido de p√°gina
    loadPageContent: function(pageName) {
        const contentContainer = $(`#${pageName}Content`);
        
        if (contentContainer.length === 0) return;
        
        this.showLoading();
        
        // Simular carga de contenido (en una implementaci√≥n real, esto ser√≠a AJAX)
        setTimeout(() => {
            this.hideLoading();
            this.renderPageContent(pageName);
        }, 500);
    },
    
    // Renderizar contenido de p√°gina
    renderPageContent: function(pageName) {
        const contentContainer = $(`#${pageName}Content`);
        
        switch (pageName) {
            case 'dashboard':
                this.renderDashboard();
                break;
            case 'lectores':
                this.renderLectoresManagement();
                break;
            case 'prestamos':
                this.renderPrestamosManagement();
                break;
            case 'donaciones':
                this.renderDonacionesManagement();
                break;
            case 'reportes':
                this.renderReportes();
                break;
            // Nuevas p√°ginas para botones de servicios
            case 'historial':
                this.verMiHistorial();
                break;
            case 'buscar-libros':
                this.buscarLibros();
                break;
            case 'buscar-materiales':
                this.buscarMateriales();
                break;
        }
    },
    
    // Renderizar Dashboard
    renderDashboard: function() {
        console.log('üîç renderDashboard called');
        console.log('üîç userSession:', this.config.userSession);
        
        if (!this.config.userSession) {
            console.log('‚ùå No user session found in renderDashboard');
            this.showAlert('Sesi√≥n no encontrada', 'warning');
            return;
        }
        
        const isBibliotecario = this.config.userSession.userType === 'BIBLIOTECARIO';
        console.log('üîç isBibliotecario:', isBibliotecario);
        console.log('üîç userType:', this.config.userSession.userType);
        
        if (isBibliotecario) {
            console.log('‚úÖ Rendering BIBLIOTECARIO dashboard');
            this.renderBibliotecarioDashboard();
        } else {
            console.log('‚úÖ Rendering LECTOR dashboard');
            this.renderLectorDashboard();
        }
    },
    
    // Renderizar Dashboard Bibliotecario
    renderBibliotecarioDashboard: function() {
        const content = `
            <div class="fade-in-up">
                <h2 class="text-gradient mb-3">üìä Dashboard Bibliotecario</h2>
                
                <!-- Estad√≠sticas principales -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalLectores">-</div>
                        <div class="stat-label">Total Lectores</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="lectoresActivos">-</div>
                        <div class="stat-label">Lectores Activos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalPrestamos">-</div>
                        <div class="stat-label">Total Pr√©stamos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="prestamosVencidos">-</div>
                        <div class="stat-label">Pr√©stamos Vencidos</div>
                    </div>
                </div>

                <!-- Acciones r√°pidas -->
                <div class="row">
                    <div class="col-4">
                        <div class="card">
                            <div class="card-header">
                                <h4 style="margin: 0;">üë• Gesti√≥n de Lectores</h4>
                            </div>
                            <div class="card-body">
                                <p>Administrar lectores registrados en el sistema</p>
                                <button class="btn btn-primary" onclick="BibliotecaSPA.navigateToPage('lectores')">
                                    Gestionar Lectores
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-4">
                        <div class="card">
                            <div class="card-header">
                                <h4 style="margin: 0;">üìö Gesti√≥n de Pr√©stamos</h4>
                            </div>
                            <div class="card-body">
                                <p>Administrar pr√©stamos y devoluciones</p>
                                <button class="btn btn-primary" onclick="BibliotecaSPA.navigateToPage('prestamos')">
                                    Gestionar Pr√©stamos
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-4">
                        <div class="card">
                            <div class="card-header">
                                <h4 style="margin: 0;">üìñ Gesti√≥n de Donaciones</h4>
                            </div>
                            <div class="card-body">
                                <p>Registrar y administrar donaciones</p>
                                <button class="btn btn-primary" onclick="BibliotecaSPA.navigateToPage('donaciones')">
                                    Gestionar Donaciones
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        $('#dashboardContent').html(content);
        this.loadDashboardStats();
    },
    
    // Cargar estad√≠sticas del dashboard de bibliotecario desde el servidor
    loadDashboardStats: function() {
        console.log('üîç loadDashboardStats called');
        
        // Cargar estad√≠sticas reales desde el servidor
        Promise.all([
            fetch('/lector/cantidad').then(r => r.json()),
            fetch('/lector/cantidad-activos').then(r => r.json()),
            fetch('/prestamo/cantidad').then(r => r.json()),
            fetch('/prestamo/cantidad-vencidos').then(r => r.json())
        ]).then(([lectoresResponse, activosResponse, prestamosResponse, vencidosResponse]) => {
            const stats = {
                totalLectores: lectoresResponse.cantidad || 0,
                lectoresActivos: activosResponse.cantidad || 0,
                totalPrestamos: prestamosResponse.cantidad || 0,
                prestamosVencidos: vencidosResponse.cantidad || 0
            };
            
            // Actualizar estad√≠sticas en el dashboard
            $('#totalLectores').text(stats.totalLectores);
            $('#lectoresActivos').text(stats.lectoresActivos);
            $('#totalPrestamos').text(stats.totalPrestamos);
            $('#prestamosVencidos').text(stats.prestamosVencidos);
            
            console.log('‚úÖ Dashboard stats loaded from server:', stats);
        }).catch(error => {
            console.error('‚ùå Error loading dashboard stats:', error);
            // En caso de error, mostrar ceros
            $('#totalLectores').text('0');
            $('#lectoresActivos').text('0');
            $('#totalPrestamos').text('0');
            $('#prestamosVencidos').text('0');
        });
    },
    
    // Renderizar Dashboard Lector
    renderLectorDashboard: function() {
        const content = `
            <div class="fade-in-up">
                <h2 class="text-gradient mb-3">üë§ Mi Dashboard</h2>
                
                <!-- Informaci√≥n personal -->
                <div class="row">
                    <div class="col-8">
                        <div class="card">
                            <div class="card-header">
                                <h4 style="margin: 0;">üë§ Mi Informaci√≥n</h4>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-6">
                                        <p><strong>Email:</strong> ${this.config.userSession?.email || '-'}</p>
                                        <p><strong>Tipo:</strong> ${this.config.userSession?.userType || '-'}</p>
                                    </div>
                                    <div class="col-6">
                                        <p><strong>Estado:</strong> <span class="badge badge-success">Activo</span></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-4">
                        <div class="card">
                            <div class="card-header">
                                <h4 style="margin: 0;">üìä Mis Estad√≠sticas</h4>
                            </div>
                            <div class="card-body">
                                <div class="stat-card">
                                    <div class="stat-number" id="misPrestamos">-</div>
                                    <div class="stat-label">Pr√©stamos Totales</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-number" id="prestamosActivos">-</div>
                                    <div class="stat-label">Pr√©stamos Activos</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Acciones r√°pidas -->
                <div class="row mt-3">
                    <div class="col-4">
                        <div class="card">
                            <div class="card-header">
                                <h4 style="margin: 0;">üìö Mis Pr√©stamos</h4>
                            </div>
                            <div class="card-body">
                                <p>Ver todos mis pr√©stamos y su estado</p>
                                <button class="btn btn-primary" onclick="BibliotecaSPA.verMisPrestamos()">
                                    Ver Mis Pr√©stamos
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-4">
                        <div class="card">
                            <div class="card-header">
                                <h4 style="margin: 0;">üìñ Solicitar Pr√©stamo</h4>
                            </div>
                            <div class="card-body">
                                <p>Solicitar un nuevo pr√©stamo de material</p>
                                <button class="btn btn-success" onclick="BibliotecaSPA.solicitarPrestamo()">
                                    Solicitar Pr√©stamo
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-4">
                        <div class="card">
                            <div class="card-header">
                                <h4 style="margin: 0;">üìö Cat√°logo de Libros</h4>
                            </div>
                            <div class="card-body">
                                <p>Explora todos los libros disponibles en nuestra biblioteca</p>
                                <button class="btn btn-secondary" onclick="BibliotecaSPA.verCatalogo()">
                                    Ver Cat√°logo de Libros
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        $('#dashboardContent').html(content);
        this.loadLectorStats();
    },
    
    // Cargar estad√≠sticas del lector desde el servidor
    loadLectorStats: async function() {
        console.log('üîç loadLectorStats called');
        
        try {
            // Obtener ID del lector desde la sesi√≥n
            const userSession = this.config.userSession;
            const lectorId = userSession && userSession.userData ? userSession.userData.id : null;
            
            if (!lectorId) {
                console.warn('‚ö†Ô∏è No se pudo obtener el ID del lector de la sesi√≥n');
                // Poner valores en 0 si no hay ID
                $('#misPrestamos').text('0');
                $('#prestamosActivos').text('0');
                return;
            }
            
            console.log('üìö Obteniendo pr√©stamos para lector ID:', lectorId);
            
            // Llamar al endpoint para obtener cantidad de pr√©stamos del lector
            const response = await $.ajax({
                url: `/prestamo/cantidad-por-lector?lectorId=${lectorId}`,
                method: 'GET',
                dataType: 'json'
            });
            
            console.log('üìä Respuesta de pr√©stamos:', response);
            
            if (response && response.success) {
                const cantidad = response.cantidad || 0;
                
                // Actualizar estad√≠sticas en el dashboard
                $('#misPrestamos').text(cantidad);
                $('#prestamosActivos').text(cantidad);  // Por ahora asumimos que todos los pr√©stamos son activos
                
                console.log('‚úÖ Lector stats loaded:', {total: cantidad, activos: cantidad});
            } else {
                console.warn('‚ö†Ô∏è Respuesta sin datos v√°lidos');
                $('#misPrestamos').text('0');
                $('#prestamosActivos').text('0');
            }
            
        } catch (error) {
            console.error('‚ùå Error al cargar estad√≠sticas del lector:', error);
            // En caso de error, mostrar 0
            $('#misPrestamos').text('0');
            $('#prestamosActivos').text('0');
        }
    },
    
    // Renderizar Gesti√≥n de Lectores
    renderLectoresManagement: function() {
        // Verificar que el usuario es bibliotecario
        if (!this.config.userSession || this.config.userSession.userType !== 'BIBLIOTECARIO') {
            this.showAlert('Acceso denegado. Solo bibliotecarios pueden gestionar lectores.', 'danger');
            this.navigateToPage('dashboard');
            return;
        }
        const content = `
            <div class="fade-in-up">
                <h2 class="text-gradient mb-3">üë• Gesti√≥n de Lectores</h2>
                
                <!-- Estad√≠sticas -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalLectores">-</div>
                        <div class="stat-label">Total Lectores</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="lectoresActivos">-</div>
                        <div class="stat-label">Lectores Activos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="lectoresSuspendidos">-</div>
                        <div class="stat-label">Lectores Suspendidos</div>
                    </div>
                </div>

                <!-- Filtros y b√∫squeda -->
                <div class="card">
                    <div class="card-header">
                        <h4 style="margin: 0;">üîç B√∫squeda y Filtros</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-4">
                                <div class="form-group">
                                    <label for="searchInput">Buscar por nombre o email:</label>
                                    <input type="text" id="searchInput" class="form-control" placeholder="Ingrese nombre o email...">
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="form-group">
                                    <label for="estadoFilter">Filtrar por estado:</label>
                                    <select id="estadoFilter" class="form-control">
                                        <option value="">Todos</option>
                                        <option value="ACTIVO">Activos</option>
                                        <option value="SUSPENDIDO">Suspendidos</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="form-group">
                                    <label for="zonaFilter">Filtrar por zona:</label>
                                    <select id="zonaFilter" class="form-control">
                                        <option value="">Todas</option>
                                        <option value="CENTRO">Centro</option>
                                        <option value="NORTE">Norte</option>
                                        <option value="SUR">Sur</option>
                                        <option value="ESTE">Este</option>
                                        <option value="OESTE">Oeste</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-2">
                                <div class="form-group">
                                    <label>&nbsp;</label>
                                    <button id="searchBtn" class="btn btn-primary" style="width: 100%;">Buscar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Acciones r√°pidas -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h4 style="margin: 0;">‚ö° Acciones R√°pidas</h4>
                            </div>
                            <div class="card-body">
                                <button class="btn btn-success" onclick="BibliotecaSPA.showRegistrarLectorModal()">
                                    ‚ûï Registrar Nuevo Lector
                                </button>
                                <button class="btn btn-primary" onclick="BibliotecaSPA.exportarLectores()">
                                    üìä Exportar Lista
                                </button>
                                <button class="btn btn-secondary" onclick="BibliotecaSPA.actualizarLista()">
                                    üîÑ Actualizar Lista
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Lista de lectores -->
                <div class="card">
                    <div class="card-header">
                        <h4 style="margin: 0;">üìã Lista de Lectores</h4>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table" id="lectoresTable">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Nombre</th>
                                        <th>Email</th>
                                        <th>Tel√©fono</th>
                                        <th>Zona</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="7" class="text-center">
                                            <div class="spinner"></div>
                                            Cargando lectores...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        $('#lectoresContent').html(content);
        this.loadLectoresData();
        this.loadLectoresManagementStats();
    },
    
    // Cargar estad√≠sticas del dashboard
    loadDashboardStats: function() {
        const isBibliotecario = this.config.userSession?.userType === 'BIBLIOTECARIO';
        
        if (isBibliotecario) {
            // Cargar estad√≠sticas para bibliotecario
            BibliotecaAPI.getLectorStats().then(stats => {
                $('#totalLectores').text(stats.total || 0);
                $('#lectoresActivos').text(stats.activos || 0);
            });
            
            BibliotecaAPI.getPrestamoStats().then(stats => {
                $('#totalPrestamos').text(stats.total || 0);
                $('#prestamosVencidos').text(stats.vencidos || 0);
            });
        } else {
            // Cargar estad√≠sticas para lector
            BibliotecaAPI.getMisPrestamoStats().then(stats => {
                $('#misPrestamos').text(stats.total || 0);
                $('#prestamosActivos').text(stats.activos || 0);
            });
        }
    },
    
    // Cargar datos de lectores
    loadLectoresData: function() {
        console.log('üîç loadLectoresData called');
        
        // Cargar datos reales desde el servidor
        fetch('/lector/lista')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (!data.success) {
                    throw new Error(data.message || 'Error al cargar lectores');
                }
                
                const lectores = data.lectores || [];
                console.log('‚úÖ Lectores loaded from server:', lectores.length);
                this.renderLectoresTable(lectores);
            })
            .catch(error => {
                console.error('‚ùå Error loading lectores:', error);
                // En caso de error, mostrar mensaje
                const tbody = $('#lectoresTable tbody');
                tbody.html('<tr><td colspan="7" class="text-center">Error al cargar los lectores: ' + error.message + '</td></tr>');
            });
    },
    
    // Cargar estad√≠sticas para la gesti√≥n de lectores
    loadLectoresManagementStats: function() {
        console.log('üîç loadLectoresManagementStats called');
        
        // Cargar estad√≠sticas reales desde el servidor
        Promise.all([
            fetch('/lector/cantidad').then(r => r.json()),
            fetch('/lector/cantidad-activos').then(r => r.json())
        ]).then(([totalResponse, activosResponse]) => {
            const total = totalResponse.cantidad || 0;
            const activos = activosResponse.cantidad || 0;
            const suspendidos = total - activos;
            
            // Actualizar estad√≠sticas en la gesti√≥n de lectores
            $('#totalLectores').text(total);
            $('#lectoresActivos').text(activos);
            $('#lectoresSuspendidos').text(suspendidos);
            
            console.log('‚úÖ Lectores management stats loaded:', { total, activos, suspendidos });
        }).catch(error => {
            console.error('‚ùå Error loading lectores management stats:', error);
            // En caso de error, mostrar ceros
            $('#totalLectores').text('0');
            $('#lectoresActivos').text('0');
            $('#lectoresSuspendidos').text('0');
        });
    },
    
    // Renderizar gesti√≥n de pr√©stamos
    renderPrestamosManagement: function() {
        // Verificar que el usuario es bibliotecario
        if (!this.config.userSession || this.config.userSession.userType !== 'BIBLIOTECARIO') {
            this.showAlert('Acceso denegado. Solo bibliotecarios pueden gestionar pr√©stamos.', 'danger');
            this.navigateToPage('dashboard');
            return;
        }
        
        const content = `
            <div class="fade-in-up">
                <h2 class="text-gradient mb-3">üìö Gesti√≥n de Pr√©stamos</h2>
                
                <!-- Estad√≠sticas -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalPrestamosGestion">-</div>
                        <div class="stat-label">Total Pr√©stamos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="prestamosActivosGestion">-</div>
                        <div class="stat-label">Pr√©stamos Activos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="prestamosVencidosGestion">-</div>
                        <div class="stat-label">Pr√©stamos Vencidos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="prestamosCompletadosGestion">-</div>
                        <div class="stat-label">Pr√©stamos Completados</div>
                    </div>
                </div>

                <!-- Filtros y b√∫squeda -->
                <div class="card">
                    <div class="card-header">
                        <h4 style="margin: 0;">üîç B√∫squeda y Filtros</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-4">
                                <div class="form-group">
                                    <label for="searchPrestamoInput">Buscar por lector o material:</label>
                                    <input type="text" id="searchPrestamoInput" class="form-control" placeholder="Ingrese nombre o t√≠tulo...">
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="form-group">
                                    <label for="estadoPrestamoFilter">Filtrar por estado:</label>
                                    <select id="estadoPrestamoFilter" class="form-control">
                                        <option value="">Todos</option>
                                        <option value="ACTIVO">Activos</option>
                                        <option value="VENCIDO">Vencidos</option>
                                        <option value="COMPLETADO">Completados</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="form-group">
                                    <label for="tipoMaterialPrestamoFilter">Filtrar por tipo:</label>
                                    <select id="tipoMaterialPrestamoFilter" class="form-control">
                                        <option value="">Todos</option>
                                        <option value="LIBRO">Libros</option>
                                        <option value="REVISTA">Revistas</option>
                                        <option value="MULTIMEDIA">Multimedia</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-2">
                                <div class="form-group">
                                    <label>&nbsp;</label>
                                    <button id="searchPrestamoBtn" class="btn btn-primary" style="width: 100%;">Buscar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Acciones r√°pidas -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h4 style="margin: 0;">‚ö° Acciones R√°pidas</h4>
                            </div>
                            <div class="card-body">
                                <button class="btn btn-success" onclick="BibliotecaSPA.registrarNuevoPrestamo()">
                                    ‚ûï Registrar Nuevo Pr√©stamo
                                </button>
                                <button class="btn btn-primary" onclick="BibliotecaSPA.exportarPrestamos()">
                                    üìä Exportar Lista
                                </button>
                                <button class="btn btn-secondary" onclick="BibliotecaSPA.actualizarListaPrestamos()">
                                    üîÑ Actualizar Lista
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Lista de pr√©stamos -->
                <div class="card">
                    <div class="card-header">
                        <h4 style="margin: 0;">üìã Lista de Pr√©stamos</h4>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table" id="prestamosGestionTable">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Lector</th>
                                        <th>Material</th>
                                        <th>Fecha Solicitud</th>
                                        <th>Fecha Devoluci√≥n</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="7" class="text-center">
                                            <div class="spinner"></div>
                                            Cargando pr√©stamos...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        $('#prestamosContent').html(content);
        this.loadPrestamosGestionData();
        this.loadPrestamosGestionStats();
    },
    
    // Cargar datos de pr√©stamos para gesti√≥n
    loadPrestamosGestionData: function() {
        console.log('üîç loadPrestamosGestionData called');
        
        fetch('/prestamo/lista')
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    throw new Error(data.message || 'Error al cargar pr√©stamos');
                }
                
                const prestamos = data.prestamos || [];
                console.log('‚úÖ Pr√©stamos loaded from server:', prestamos.length);
                this.renderPrestamosGestionTable(prestamos);
            })
            .catch(error => {
                console.error('‚ùå Error loading pr√©stamos:', error);
                const tbody = $('#prestamosGestionTable tbody');
                tbody.html('<tr><td colspan="7" class="text-center">Error al cargar los pr√©stamos: ' + error.message + '</td></tr>');
            });
    },
    
    // Cargar estad√≠sticas de pr√©stamos
    loadPrestamosGestionStats: function() {
        console.log('üîç loadPrestamosGestionStats called');
        
        Promise.all([
            fetch('/prestamo/cantidad').then(r => r.json()),
            fetch('/prestamo/cantidad-activos').then(r => r.json()),
            fetch('/prestamo/cantidad-vencidos').then(r => r.json()),
            fetch('/prestamo/cantidad-completados').then(r => r.json())
        ]).then(([totalResponse, activosResponse, vencidosResponse, completadosResponse]) => {
            const total = totalResponse.cantidad || 0;
            const activos = activosResponse.cantidad || 0;
            const vencidos = vencidosResponse.cantidad || 0;
            const completados = completadosResponse.cantidad || 0;
            
            $('#totalPrestamosGestion').text(total);
            $('#prestamosActivosGestion').text(activos);
            $('#prestamosVencidosGestion').text(vencidos);
            $('#prestamosCompletadosGestion').text(completados);
            
            console.log('‚úÖ Pr√©stamos stats loaded:', { total, activos, vencidos, completados });
        }).catch(error => {
            console.error('‚ùå Error loading pr√©stamos stats:', error);
            $('#totalPrestamosGestion').text('0');
            $('#prestamosActivosGestion').text('0');
            $('#prestamosVencidosGestion').text('0');
            $('#prestamosCompletadosGestion').text('0');
        });
    },
    
    // Renderizar tabla de pr√©stamos
    renderPrestamosGestionTable: function(prestamos) {
        const tbody = $('#prestamosGestionTable tbody');
        tbody.empty();
        
        if (prestamos.length === 0) {
            tbody.html('<tr><td colspan="7" class="text-center">No hay pr√©stamos registrados</td></tr>');
            return;
        }
        
        prestamos.forEach(prestamo => {
            let estadoBadge = '';
            if (prestamo.estado === 'ACTIVO') {
                estadoBadge = '<span class="badge badge-success">Activo</span>';
            } else if (prestamo.estado === 'VENCIDO') {
                estadoBadge = '<span class="badge badge-danger">Vencido</span>';
            } else if (prestamo.estado === 'COMPLETADO') {
                estadoBadge = '<span class="badge badge-info">Completado</span>';
            }
            
            const row = `
                <tr>
                    <td>${prestamo.id}</td>
                    <td>${prestamo.lectorNombre || 'N/A'}</td>
                    <td>${prestamo.materialTitulo || 'N/A'}</td>
                    <td>${prestamo.fechaSolicitud || 'N/A'}</td>
                    <td>${prestamo.fechaDevolucion || 'N/A'}</td>
                    <td>${estadoBadge}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="BibliotecaSPA.verDetallesPrestamo(${prestamo.id})">
                            üëÅÔ∏è Ver
                        </button>
                        <button class="btn btn-success btn-sm" onclick="BibliotecaSPA.procesarDevolucion(${prestamo.id})">
                            ‚Ü©Ô∏è Devolver
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="BibliotecaSPA.renovarPrestamo(${prestamo.id})">
                            üîÑ Renovar
                        </button>
                    </td>
                </tr>
            `;
            tbody.append(row);
        });
    },
    
    // Renderizar gesti√≥n de donaciones
    renderDonacionesManagement: function() {
        // Verificar que el usuario es bibliotecario
        if (!this.config.userSession || this.config.userSession.userType !== 'BIBLIOTECARIO') {
            this.showAlert('Acceso denegado. Solo bibliotecarios pueden gestionar donaciones.', 'danger');
            this.navigateToPage('dashboard');
            return;
        }
        
        const content = `
            <div class="fade-in-up">
                <h2 class="text-gradient mb-3">üéÅ Gesti√≥n de Donaciones</h2>
                
                <!-- Estad√≠sticas -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalLibrosDonados">-</div>
                        <div class="stat-label">Total Libros Donados</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalArticulosDonados">-</div>
                        <div class="stat-label">Total Art√≠culos Donados</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="donacionesDisponibles">-</div>
                        <div class="stat-label">Donaciones Disponibles</div>
                    </div>
                </div>

                <!-- Tabs para Libros y Art√≠culos -->
                <div class="card">
                    <div class="card-header">
                        <ul class="nav nav-tabs">
                            <li class="nav-item">
                                <a class="nav-link active" id="libros-tab" data-toggle="tab" href="#libros-panel">
                                    üìö Libros Donados
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="articulos-tab" data-toggle="tab" href="#articulos-panel">
                                    üìÑ Art√≠culos Especiales
                                </a>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div class="tab-content">
                            <!-- Panel de Libros -->
                            <div class="tab-pane fade show active" id="libros-panel">
                                <div class="table-responsive">
                                    <table class="table" id="librosDonadosTable">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>T√≠tulo</th>
                                                <th>P√°ginas</th>
                                                <th>Estado</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td colspan="5" class="text-center">
                                                    <div class="spinner"></div>
                                                    Cargando libros donados...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Panel de Art√≠culos -->
                            <div class="tab-pane fade" id="articulos-panel">
                                <div class="table-responsive">
                                    <table class="table" id="articulosDonadosTable">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Descripci√≥n</th>
                                                <th>Peso</th>
                                                <th>Dimensiones</th>
                                                <th>Estado</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td colspan="6" class="text-center">
                                                    <div class="spinner"></div>
                                                    Cargando art√≠culos donados...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        $('#donacionesContent').html(content);
        this.loadDonacionesData();
        this.loadDonacionesStats();
        this.setupDonacionesTabs();
    },
    
    // Configurar tabs de donaciones
    setupDonacionesTabs: function() {
        $('#libros-tab').click(function(e) {
            e.preventDefault();
            $('#libros-tab').addClass('active');
            $('#articulos-tab').removeClass('active');
            $('#libros-panel').addClass('show active');
            $('#articulos-panel').removeClass('show active');
        });
        
        $('#articulos-tab').click(function(e) {
            e.preventDefault();
            $('#articulos-tab').addClass('active');
            $('#libros-tab').removeClass('active');
            $('#articulos-panel').addClass('show active');
            $('#libros-panel').removeClass('show active');
        });
    },
    
    // Cargar datos de donaciones
    loadDonacionesData: function() {
        console.log('üîç loadDonacionesData called');
        
        // Cargar libros donados
        fetch('/donacion/libros')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.libros) {
                    console.log('‚úÖ Libros donados loaded:', data.libros.length);
                    this.renderLibrosDonadosTable(data.libros);
                } else {
                    throw new Error(data.message || 'Error al cargar libros donados');
                }
            })
            .catch(error => {
                console.error('‚ùå Error loading libros donados:', error);
                const tbody = $('#librosDonadosTable tbody');
                tbody.html('<tr><td colspan="5" class="text-center">Error al cargar los libros donados</td></tr>');
            });
        
        // Cargar art√≠culos donados
        fetch('/donacion/articulos')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.articulos) {
                    console.log('‚úÖ Art√≠culos donados loaded:', data.articulos.length);
                    this.renderArticulosDonadosTable(data.articulos);
                } else {
                    throw new Error(data.message || 'Error al cargar art√≠culos donados');
                }
            })
            .catch(error => {
                console.error('‚ùå Error loading art√≠culos donados:', error);
                const tbody = $('#articulosDonadosTable tbody');
                tbody.html('<tr><td colspan="6" class="text-center">Error al cargar los art√≠culos donados</td></tr>');
            });
    },
    
    // Cargar estad√≠sticas de donaciones
    loadDonacionesStats: function() {
        console.log('üîç loadDonacionesStats called');
        
        Promise.all([
            fetch('/donacion/cantidad-libros').then(r => r.json()),
            fetch('/donacion/cantidad-articulos').then(r => r.json())
        ]).then(([librosResponse, articulosResponse]) => {
            const totalLibros = librosResponse.cantidad || 0;
            const totalArticulos = articulosResponse.cantidad || 0;
            const totalDisponibles = totalLibros + totalArticulos;
            
            $('#totalLibrosDonados').text(totalLibros);
            $('#totalArticulosDonados').text(totalArticulos);
            $('#donacionesDisponibles').text(totalDisponibles);
            
            console.log('‚úÖ Donaciones stats loaded:', { totalLibros, totalArticulos, totalDisponibles });
        }).catch(error => {
            console.error('‚ùå Error loading donaciones stats:', error);
            $('#totalLibrosDonados').text('0');
            $('#totalArticulosDonados').text('0');
            $('#donacionesDisponibles').text('0');
        });
    },
    
    // Renderizar tabla de libros donados
    renderLibrosDonadosTable: function(libros) {
        const tbody = $('#librosDonadosTable tbody');
        tbody.empty();
        
        if (libros.length === 0) {
            tbody.html('<tr><td colspan="5" class="text-center">No hay libros donados registrados</td></tr>');
            return;
        }
        
        libros.forEach(libro => {
            const estadoBadge = '<span class="badge badge-success">Disponible</span>';
            
            const row = `
                <tr>
                    <td>${libro.id}</td>
                    <td>${libro.titulo || 'N/A'}</td>
                    <td>${libro.paginas || 'N/A'}</td>
                    <td>${estadoBadge}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="BibliotecaSPA.verDetallesLibroDonado(${libro.id})">
                            üëÅÔ∏è Ver
                        </button>
                    </td>
                </tr>
            `;
            tbody.append(row);
        });
    },
    
    // Renderizar tabla de art√≠culos donados
    renderArticulosDonadosTable: function(articulos) {
        const tbody = $('#articulosDonadosTable tbody');
        tbody.empty();
        
        if (articulos.length === 0) {
            tbody.html('<tr><td colspan="6" class="text-center">No hay art√≠culos donados registrados</td></tr>');
            return;
        }
        
        articulos.forEach(articulo => {
            const estadoBadge = '<span class="badge badge-success">Disponible</span>';
            
            const row = `
                <tr>
                    <td>${articulo.id}</td>
                    <td>${articulo.descripcion || 'N/A'}</td>
                    <td>${articulo.peso || 'N/A'} kg</td>
                    <td>${articulo.dimensiones || 'N/A'}</td>
                    <td>${estadoBadge}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="BibliotecaSPA.verDetallesArticuloDonado(${articulo.id})">
                            üëÅÔ∏è Ver
                        </button>
                    </td>
                </tr>
            `;
            tbody.append(row);
        });
    },
    
    // Renderizar reportes
    renderReportes: function() {
        // Verificar que el usuario es bibliotecario
        if (!this.config.userSession || this.config.userSession.userType !== 'BIBLIOTECARIO') {
            this.showAlert('Acceso denegado. Solo bibliotecarios pueden ver reportes.', 'danger');
            this.navigateToPage('dashboard');
            return;
        }
        
        const content = `
            <div class="fade-in-up">
                <h2 class="text-gradient mb-3">üìä Reportes</h2>
                
                <!-- Secci√≥n de reportes -->
                <div class="row">
                    <div class="col-6">
                        <div class="card">
                            <div class="card-header">
                                <h4 style="margin: 0;">üìà Reporte de Pr√©stamos</h4>
                            </div>
                            <div class="card-body">
                                <p>Generar reporte detallado de pr√©stamos</p>
                                <button class="btn btn-primary" onclick="BibliotecaSPA.generarReportePrestamos()">
                                    Generar Reporte
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-6">
                        <div class="card">
                            <div class="card-header">
                                <h4 style="margin: 0;">üë• Reporte de Lectores</h4>
                            </div>
                            <div class="card-body">
                                <p>Generar reporte detallado de lectores</p>
                                <button class="btn btn-primary" onclick="BibliotecaSPA.generarReporteLectores()">
                                    Generar Reporte
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-6">
                        <div class="card">
                            <div class="card-header">
                                <h4 style="margin: 0;">üéÅ Reporte de Donaciones</h4>
                            </div>
                            <div class="card-body">
                                <p>Generar reporte detallado de donaciones</p>
                                <button class="btn btn-primary" onclick="BibliotecaSPA.generarReporteDonaciones()">
                                    Generar Reporte
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-6">
                        <div class="card">
                            <div class="card-header">
                                <h4 style="margin: 0;">üìö Reporte de Materiales</h4>
                            </div>
                            <div class="card-body">
                                <p>Generar reporte detallado de materiales</p>
                                <button class="btn btn-primary" onclick="BibliotecaSPA.generarReporteMateriales()">
                                    Generar Reporte
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        $('#reportesContent').html(content);
    },
    
    // Renderizar tabla de lectores
    renderLectoresTable: function(lectores) {
        const tbody = $('#lectoresTable tbody');
        tbody.empty();
        
        lectores.forEach(lector => {
            const estadoBadge = lector.estado === 'ACTIVO' ? 
                '<span class="badge badge-success">Activo</span>' : 
                '<span class="badge badge-warning">Suspendido</span>';
            
            const row = `
                <tr>
                    <td>${lector.id}</td>
                    <td>${lector.nombre} ${lector.apellido}</td>
                    <td>${lector.email}</td>
                    <td>${lector.telefono}</td>
                    <td>${lector.zona}</td>
                    <td>${estadoBadge}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="BibliotecaSPA.verDetallesLector(${lector.id})">
                            üëÅÔ∏è Ver
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="BibliotecaSPA.cambiarEstadoLector(${lector.id}, '${lector.estado}')">
                            üîÑ Cambiar Estado
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="BibliotecaSPA.cambiarZonaLector(${lector.id})">
                            üìç Cambiar Zona
                        </button>
                    </td>
                </tr>
            `;
            tbody.append(row);
        });
    },
    
    // Mostrar loading
    showLoading: function(message = 'Cargando...') {
        const loadingHtml = `
            <div id="loadingOverlay" class="loading-overlay fade-in">
                <div class="loading-content">
                    <div class="spinner"></div>
                    <p>${message}</p>
                    <div class="loading-progress">
                        <div class="progress-bar"></div>
                    </div>
                </div>
            </div>
        `;
        $('#loadingOverlay').remove(); // Remover si existe
        $('body').append(loadingHtml);
        
        // Animar la barra de progreso
        setTimeout(() => {
            $('.progress-bar').css('width', '100%');
        }, 100);
    },
    
    // Ocultar loading
    hideLoading: function() {
        $('#loadingOverlay').addClass('fade-out');
        setTimeout(() => {
            $('#loadingOverlay').remove();
        }, 300);
    },
    
    // Loading con progreso
    showProgressLoading: function(message = 'Procesando...') {
        this.showLoading(message);
        this.animateProgress();
    },
    
    // Animar progreso
    animateProgress: function() {
        let progress = 0;
        const interval = setInterval(() => {
            progress += Math.random() * 15;
            if (progress >= 90) {
                progress = 90;
                clearInterval(interval);
            }
            $('.progress-bar').css('width', progress + '%');
        }, 200);
        
        return interval;
    },
    
    // Mostrar alerta
    showAlert: function(message, type = 'info') {
        const alertHtml = `
            <div class="alert alert-${type} fade-in-up">
                ${message}
            </div>
        `;
        
        $('#mainContent').prepend(alertHtml);
        
        // Auto-remove despu√©s de 5 segundos
        setTimeout(() => {
            $('.alert').fadeOut(300, function() {
                $(this).remove();
            });
        }, 5000);
    },
    
    // Manejar login
    handleLogin: async function() {
        const formData = {
            userType: $('#userType').val(),
            email: $('#email').val(),
            password: $('#password').val()
        };
        
        if (!this.validateLoginForm(formData)) {
            return;
        }
        
        this.showLoading();
        
        try {
            const response = await BibliotecaAPI.login(formData);
            
            if (response.success) {
                // Convertir tipo de usuario a formato est√°ndar
                const userType = formData.userType === 'BIBLIOTECARIO' ? 'BIBLIOTECARIO' : 'LECTOR';
                console.log('üîç Login successful, userType:', userType);
                console.log('üîç formData.userType:', formData.userType);
                
                // Obtener datos del usuario desde el servidor (ahora es async)
                try {
                    const userData = await this.getUserData(formData.email, userType);
                    console.log('üîç userData:', userData);
                    
                    // Verificar que userData tenga un ID v√°lido
                    if (!userData || !userData.id) {
                        throw new Error('Los datos del usuario no contienen un ID v√°lido');
                    }
                    
                    this.config.userSession = {
                        userType: userType,
                        email: formData.email,
                        originalUserType: formData.userType,
                        nombre: userData.nombre,
                        apellido: userData.apellido,
                        nombreCompleto: `${userData.nombre} ${userData.apellido}`,
                        userData: userData  // Guardar todos los datos del usuario incluyendo el ID
                    };
                    console.log('üîç userSession created:', this.config.userSession);
                    
                    sessionStorage.setItem('bibliotecaUserSession', JSON.stringify(this.config.userSession));
                    console.log('üîç userSession saved to storage');
                    
                    // Mostrar UI autenticada
                    this.showAuthenticatedUI();
                    this.updateNavigationForRole();
                    
                    // Navegar al dashboard y actualizar URL
                    this.navigateToPage('dashboard');
                    
                    this.hideLoading();
                    this.showAlert('Login exitoso', 'success');
                } catch (userDataError) {
                    console.error('‚ùå Error obteniendo datos del usuario:', userDataError);
                    this.hideLoading();
                    this.showAlert('Error al cargar datos del usuario: ' + userDataError.message, 'danger');
                }
            } else {
                this.hideLoading();
                this.showAlert('Credenciales inv√°lidas', 'danger');
            }
        } catch (error) {
            console.error('‚ùå Error en login:', error);
            this.hideLoading();
            this.showAlert('Error en el sistema: ' + error.message, 'danger');
        }
    },
    
    // Manejar registro
    handleRegister: function() {
        const formData = {
            userType: $('#regUserType').val(),
            nombre: $('#regNombre').val(),
            apellido: $('#regApellido').val(),
            email: $('#regEmail').val(),
            telefono: $('#regTelefono').val(),
            password: $('#regPassword').val(),
            confirmPassword: $('#regConfirmPassword').val()
        };
        
        // Agregar campos espec√≠ficos
        if (formData.userType === 'BIBLIOTECARIO') {
            formData.numeroEmpleado = $('#regNumeroEmpleado').val();
        } else if (formData.userType === 'LECTOR') {
            formData.direccion = $('#regDireccion').val();
            formData.zona = $('#regZona').val();
        }
        
        if (!this.validateRegisterForm(formData)) {
            return;
        }
        
        this.showLoading();
        
        BibliotecaAPI.register(formData).then(response => {
            this.hideLoading();
            if (response.success) {
                this.showAlert('Usuario registrado exitosamente. Por favor inicie sesi√≥n.', 'success');
                this.showPage('login');
                $('#registerForm')[0].reset();
            } else {
                this.showAlert('Error al registrar usuario: ' + response.message, 'danger');
            }
        }).catch(error => {
            this.hideLoading();
            this.showAlert('Error en el sistema: ' + error.message, 'danger');
        });
    },
    
    // Validar formulario de login
    validateLoginForm: function(data) {
        if (!data.userType) {
            this.showAlert('Por favor seleccione un tipo de usuario', 'danger');
            return false;
        }
        
        if (!data.email || !this.isValidEmail(data.email)) {
            this.showAlert('Por favor ingrese un email v√°lido', 'danger');
            return false;
        }
        
        if (!data.password || data.password.length < 6) {
            this.showAlert('La contrase√±a debe tener al menos 6 caracteres', 'danger');
            return false;
        }
        
        return true;
    },
    
    // Validar formulario de registro
    validateRegisterForm: function(data) {
        if (!data.userType) {
            this.showAlert('Por favor seleccione un tipo de usuario', 'danger');
            return false;
        }
        
        if (!data.nombre || !data.apellido) {
            this.showAlert('Por favor complete nombre y apellido', 'danger');
            return false;
        }
        
        if (!this.isValidEmail(data.email)) {
            this.showAlert('Por favor ingrese un email v√°lido', 'danger');
            return false;
        }
        
        if (data.password !== data.confirmPassword) {
            this.showAlert('Las contrase√±as no coinciden', 'danger');
            return false;
        }
        
        if (data.password.length < 8) {
            this.showAlert('La contrase√±a debe tener al menos 8 caracteres', 'danger');
            return false;
        }
        
        return true;
    },
    
    // Validar email
    isValidEmail: function(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    },
    
    // Logout
    logout: function() {
        // Limpiar sesi√≥n
        sessionStorage.removeItem('bibliotecaUserSession');
        this.config.userSession = null;
        
        // Ocultar navegaci√≥n autenticada
        $('#mainNavigation').hide();
        
        // Limpiar historial y redirigir
        history.replaceState({ page: 'login' }, '', window.location.pathname);
        this.config.currentPage = 'login';
        
        // Mostrar p√°gina de login
        this.showPage('login');
        
        // Limpiar formularios
        $('#loginForm')[0].reset();
        $('#registerForm')[0].reset();
        
        this.showAlert('Sesi√≥n cerrada exitosamente', 'success');
    },
    
    // M√©todos placeholder para gesti√≥n
    showRegistrarLectorModal: function() {
        this.showAlert('Modal de registro de lector en desarrollo', 'info');
    },
    
    exportarLectores: function() {
        this.showAlert('Funci√≥n de exportaci√≥n en desarrollo', 'info');
    },
    
    actualizarLista: function() {
        this.loadLectoresData();
        this.showAlert('Lista actualizada', 'success');
    },
    
    verDetallesLector: function(id) {
        this.showAlert(`Ver detalles del lector ID: ${id}`, 'info');
    },
    
    cambiarEstadoLector: function(id, estado) {
        const nuevoEstado = estado === 'ACTIVO' ? 'SUSPENDIDO' : 'ACTIVO';
        const accion = nuevoEstado === 'SUSPENDIDO' ? 'suspender' : 'reactivar';
        
        // Mostrar modal de confirmaci√≥n
        this.showConfirmModal(
            `¬øEst√° seguro de que desea ${accion} este lector?`,
            `Esta acci√≥n cambiar√° el estado del lector a "${nuevoEstado}".`,
            () => {
                this.showLoading('Cambiando estado del lector...');
                
                // Llamar al API real
                BibliotecaAPI.lectores.changeStatus(id, nuevoEstado).then(response => {
                    this.hideLoading();
                    if (response.success) {
                        this.showAlert(`Estado del lector cambiado a ${nuevoEstado}`, 'success');
                        this.loadLectoresData();
                    } else {
                        this.showAlert('Error al cambiar estado: ' + (response.message || 'Error desconocido'), 'danger');
                    }
                }).catch(error => {
                    this.hideLoading();
                    this.showAlert('Error al comunicarse con el servidor', 'danger');
                    console.error('Error cambiando estado:', error);
                });
            }
        );
    },
    
    cambiarZonaLector: function(id) {
        // Obtener datos del lector actual
        const lectores = this.getLectoresData();
        const lector = lectores.find(l => l.id === id);
        
        if (!lector) {
            this.showAlert('Lector no encontrado', 'danger');
            return;
        }
        
        // Mostrar modal para cambiar zona
        this.showZonaChangeModal(lector);
    },
    
    // Mostrar modal de cambio de zona
    showZonaChangeModal: function(lector) {
        const modalHtml = `
            <div id="zonaChangeModal" class="modal fade-in">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>üìç Cambiar Zona del Lector</h3>
                        <button class="modal-close" onclick="BibliotecaSPA.closeModal('zonaChangeModal')">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="lector-info">
                            <p><strong>Lector:</strong> ${lector.nombre} ${lector.apellido}</p>
                            <p><strong>Zona Actual:</strong> ${lector.zona}</p>
                        </div>
                        
                        <div class="form-group">
                            <label for="nuevaZona">Nueva Zona:</label>
                            <select id="nuevaZona" class="form-control" required>
                                <option value="">Seleccione una zona...</option>
                                <option value="CENTRO" ${lector.zona === 'CENTRO' ? 'selected' : ''}>Centro</option>
                                <option value="NORTE" ${lector.zona === 'NORTE' ? 'selected' : ''}>Norte</option>
                                <option value="SUR" ${lector.zona === 'SUR' ? 'selected' : ''}>Sur</option>
                                <option value="ESTE" ${lector.zona === 'ESTE' ? 'selected' : ''}>Este</option>
                                <option value="OESTE" ${lector.zona === 'OESTE' ? 'selected' : ''}>Oeste</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="motivoCambio">Motivo del Cambio (opcional):</label>
                            <textarea id="motivoCambio" class="form-control" rows="3" 
                                      placeholder="Explique el motivo del cambio de zona..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="BibliotecaSPA.closeModal('zonaChangeModal')">
                            Cancelar
                        </button>
                        <button class="btn btn-primary" onclick="BibliotecaSPA.confirmarCambioZona(${lector.id})">
                            Cambiar Zona
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        // Remover modal existente si existe
        $('#zonaChangeModal').remove();
        $('body').append(modalHtml);
    },
    
    // Confirmar cambio de zona
    confirmarCambioZona: function(lectorId) {
        const nuevaZona = $('#nuevaZona').val();
        const motivo = $('#motivoCambio').val();
        
        if (!nuevaZona) {
            this.showAlert('Por favor seleccione una nueva zona', 'danger');
            return;
        }
        
        // Obtener datos del lector
        const lectores = this.getLectoresData();
        const lector = lectores.find(l => l.id === lectorId);
        
        if (lector.zona === nuevaZona) {
            this.showAlert('La nueva zona debe ser diferente a la actual', 'warning');
            return;
        }
        
        this.showLoading('Cambiando zona del lector...');
        
        // Llamar al API real
        BibliotecaAPI.lectores.changeZone(lectorId, nuevaZona).then(response => {
            this.hideLoading();
            this.closeModal('zonaChangeModal');
            if (response.success) {
                this.showAlert(`Zona del lector cambiada de ${lector.zona} a ${nuevaZona}`, 'success');
                this.loadLectoresData();
            } else {
                this.showAlert('Error al cambiar zona: ' + (response.message || 'Error desconocido'), 'danger');
            }
        }).catch(error => {
            this.hideLoading();
            this.closeModal('zonaChangeModal');
            this.showAlert('Error al comunicarse con el servidor', 'danger');
            console.error('Error cambiando zona:', error);
        });
    },
    
    // Mostrar modal de confirmaci√≥n
    showConfirmModal: function(titulo, mensaje, onConfirm) {
        const modalHtml = `
            <div id="confirmModal" class="modal fade-in">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>‚ö†Ô∏è ${titulo}</h3>
                        <button class="modal-close" onclick="BibliotecaSPA.closeModal('confirmModal')">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p>${mensaje}</p>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="BibliotecaSPA.closeModal('confirmModal')">
                            Cancelar
                        </button>
                        <button class="btn btn-danger" onclick="BibliotecaSPA.executeConfirmAction()">
                            Confirmar
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        // Guardar la funci√≥n de confirmaci√≥n
        this.pendingConfirmAction = onConfirm;
        
        // Remover modal existente si existe
        $('#confirmModal').remove();
        $('body').append(modalHtml);
    },
    
    // Ejecutar acci√≥n de confirmaci√≥n
    executeConfirmAction: function() {
        if (this.pendingConfirmAction) {
            this.pendingConfirmAction();
            this.pendingConfirmAction = null;
        }
        this.closeModal('confirmModal');
    },
    
    // Cerrar modal
    closeModal: function(modalId) {
        $(`#${modalId}`).addClass('fade-out');
        setTimeout(() => {
            $(`#${modalId}`).remove();
        }, 300);
    },
    
    // Mostrar modal informativo
    showModal: function(titulo, contenido) {
        const modalHtml = `
            <div id="infoModal" class="modal fade-in">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>${titulo}</h3>
                        <button class="modal-close" onclick="BibliotecaSPA.closeModal('infoModal')">&times;</button>
                    </div>
                    <div class="modal-body">
                        ${contenido}
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-primary" onclick="BibliotecaSPA.closeModal('infoModal')">
                            Cerrar
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        // Remover modal existente si existe
        $('#infoModal').remove();
        $('body').append(modalHtml);
    },
    
    // Obtener datos de lectores desde el servidor
    getLectoresData: function() {
        console.log('üîç Getting lectores data from server');
        
        // En una implementaci√≥n real, esto har√≠a una llamada al servidor
        // Por ahora, retornamos array vac√≠o para usuarios nuevos
        return [];
    },
    
    // ==================== FUNCIONALIDADES DEL LECTOR ====================
    
    // Ver mis pr√©stamos
    verMisPrestamos: function() {
        this.showLoading('Cargando mis pr√©stamos...');
        
        // Simular carga de datos
        setTimeout(() => {
            this.hideLoading();
            this.renderMisPrestamos();
        }, 1000);
    },
    
    // Renderizar p√°gina de mis pr√©stamos
    renderMisPrestamos: function() {
        const content = `
            <div class="fade-in-up">
                <h2 class="text-gradient mb-3">üìö Mis Pr√©stamos</h2>
                
                <!-- Filtros -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h4 style="margin: 0;">üîç Filtros</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-4">
                                <div class="form-group">
                                    <label for="estadoFilterPrestamos">Filtrar por estado:</label>
                                    <select id="estadoFilterPrestamos" class="form-control">
                                        <option value="">Todos</option>
                                        <option value="EN_CURSO">En Curso</option>
                                        <option value="DEVUELTO">Devueltos</option>
                                        <option value="PENDIENTE">Pendientes</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="form-group">
                                    <label for="tipoMaterialFilter">Filtrar por tipo:</label>
                                    <select id="tipoMaterialFilter" class="form-control">
                                        <option value="">Todos</option>
                                        <option value="LIBRO">Libros</option>
                                        <option value="ARTICULO">Art√≠culos Especiales</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-2">
                                <div class="form-group">
                                    <label>&nbsp;</label>
                                    <button class="btn btn-primary" onclick="BibliotecaSPA.aplicarFiltrosPrestamos()" style="width: 100%;">
                                        üîç Aplicar
                                    </button>
                                </div>
                            </div>
                            <div class="col-2">
                                <div class="form-group">
                                    <label>&nbsp;</label>
                                    <button class="btn btn-secondary" onclick="BibliotecaSPA.limpiarFiltrosPrestamos()" style="width: 100%;">
                                        üîÑ Limpiar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Estad√≠sticas -->
                <div class="stats-grid mb-3">
                    <div class="stat-card">
                        <div class="stat-number" id="totalMisPrestamos">-</div>
                        <div class="stat-label">Total Pr√©stamos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="prestamosEnCurso">-</div>
                        <div class="stat-label">En Curso</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="prestamosVencidos">-</div>
                        <div class="stat-label">Vencidos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="prestamosDevueltos">-</div>
                        <div class="stat-label">Devueltos</div>
                    </div>
                </div>
                
                <!-- Lista de pr√©stamos -->
                <div class="card">
                    <div class="card-header">
                        <h4 style="margin: 0;">üìã Lista de Mis Pr√©stamos</h4>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table" id="misPrestamosTable">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Material</th>
                                        <th>Tipo</th>
                                        <th>Fecha Solicitud</th>
                                        <th>Fecha Devoluci√≥n</th>
                                        <th>Estado</th>
                                        <th>Bibliotecario</th>
                                        <th>D√≠as Restantes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="8" class="text-center">
                                            <div class="spinner"></div>
                                            Cargando pr√©stamos...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Crear nueva p√°gina
        const pageId = 'misPrestamosPage';
        if ($(`#${pageId}`).length === 0) {
            $('main').append(`<div id="${pageId}" class="page" style="display: none;"></div>`);
        }
        
        $(`#${pageId}`).html(content);
        this.showPage('misPrestamos');
        this.loadMisPrestamosData();
        
        // Agregar listeners para filtrado autom√°tico
        setTimeout(() => {
            $('#estadoFilterPrestamos, #tipoMaterialFilter').on('change', function() {
                BibliotecaSPA.aplicarFiltrosPrestamos();
            });
        }, 100);
    },
    
    // Cargar datos de mis pr√©stamos desde el servidor
    loadMisPrestamosData: async function() {
        console.log('üîç Loading mis prestamos data from server');
        
        try {
            // Obtener ID del lector desde la sesi√≥n
            const userSession = this.config.userSession;
            const lectorId = userSession && userSession.userData ? userSession.userData.id : null;
            
            if (!lectorId) {
                console.warn('‚ö†Ô∏è No se pudo obtener el ID del lector de la sesi√≥n');
                this.config.allPrestamos = []; // Guardar copia vac√≠a
                this.renderMisPrestamosTable([]);
                this.updateMisPrestamosStats([]);
                return;
            }
            
            console.log('üìö Obteniendo pr√©stamos del lector ID:', lectorId);
            
            // Llamar al endpoint para obtener lista de pr√©stamos del lector
            const response = await BibliotecaAPI.prestamos.getListByLector(lectorId);
            
            console.log('üìä Respuesta de pr√©stamos del lector:', response);
            
            if (response.success && response.prestamos) {
                const prestamos = response.prestamos;
                console.log(`‚úÖ ${prestamos.length} pr√©stamos cargados`);
                
                // Guardar todos los pr√©stamos para filtrado
                this.config.allPrestamos = prestamos;
                
                this.renderMisPrestamosTable(prestamos);
                this.updateMisPrestamosStats(prestamos);
            } else {
                console.warn('‚ö†Ô∏è No se encontraron pr√©stamos');
                this.config.allPrestamos = []; // Guardar copia vac√≠a
                this.renderMisPrestamosTable([]);
                this.updateMisPrestamosStats([]);
            }
        } catch (error) {
            console.error('‚ùå Error al cargar pr√©stamos:', error);
            this.config.allPrestamos = []; // Guardar copia vac√≠a
            this.renderMisPrestamosTable([]);
            this.updateMisPrestamosStats([]);
        }
    },
    
    // Renderizar tabla de mis pr√©stamos
    renderMisPrestamosTable: function(prestamos) {
        const tbody = $('#misPrestamosTable tbody');
        tbody.empty();
        
        prestamos.forEach(prestamo => {
            const estadoBadge = this.getEstadoBadge(prestamo.estado);
            const diasRestantes = prestamo.diasRestantes > 0 ? prestamo.diasRestantes : 'Vencido';
            const diasClass = prestamo.diasRestantes <= 0 ? 'text-danger' : prestamo.diasRestantes <= 3 ? 'text-warning' : '';
            
            const bibliotecario = prestamo.bibliotecario || 'No asignado';
            
            const row = `
                <tr>
                    <td>${prestamo.id}</td>
                    <td>${prestamo.material}</td>
                    <td>${prestamo.tipo === 'LIBRO' ? 'üìö Libro' : 'üé® Art√≠culo'}</td>
                    <td>${prestamo.fechaSolicitud}</td>
                    <td>${prestamo.fechaDevolucion}</td>
                    <td>${estadoBadge}</td>
                    <td>üë®‚Äçüíº ${bibliotecario}</td>
                    <td class="${diasClass}">${diasRestantes}</td>
                </tr>
            `;
            tbody.append(row);
        });
    },
    
    // Obtener badge de estado
    getEstadoBadge: function(estado) {
        const badges = {
            'EN_CURSO': '<span class="badge badge-success">En Curso</span>',
            'DEVUELTO': '<span class="badge badge-info">Devuelto</span>',
            'PENDIENTE': '<span class="badge badge-warning">Pendiente</span>',
            'VENCIDO': '<span class="badge badge-danger">Vencido</span>'
        };
        return badges[estado] || '<span class="badge badge-secondary">Desconocido</span>';
    },
    
    // Convertir fecha de formato YYYY-MM-DD a DD/MM/YYYY para el servidor
    convertDateToServerFormat: function(dateString) {
        if (!dateString) return '';
        
        // dateString viene en formato YYYY-MM-DD del input type="date"
        const parts = dateString.split('-');
        if (parts.length !== 3) return dateString;
        
        const [year, month, day] = parts;
        // Retornar en formato DD/MM/YYYY
        return `${day}/${month}/${year}`;
    },
    
    // Actualizar estad√≠sticas de mis pr√©stamos
    updateMisPrestamosStats: function(prestamos) {
        const total = prestamos.length;
        const enCurso = prestamos.filter(p => p.estado === 'EN_CURSO').length;
        const vencidos = prestamos.filter(p => p.diasRestantes <= 0).length;
        const devueltos = prestamos.filter(p => p.estado === 'DEVUELTO').length;
        
        $('#totalMisPrestamos').text(total);
        $('#prestamosEnCurso').text(enCurso);
        $('#prestamosVencidos').text(vencidos);
        $('#prestamosDevueltos').text(devueltos);
    },
    
    // Solicitar pr√©stamo
    solicitarPrestamo: function() {
        this.showLoading('Cargando formulario de pr√©stamo...');
        
        setTimeout(() => {
            this.hideLoading();
            this.renderSolicitarPrestamo();
        }, 1000);
    },
    
    // Renderizar formulario de solicitar pr√©stamo
    renderSolicitarPrestamo: function() {
        const content = `
            <div class="fade-in-up">
                <h2 class="text-gradient mb-3">üìñ Solicitar Nuevo Pr√©stamo</h2>
                
                <div class="row">
                    <div class="col-8">
                        <div class="card">
                            <div class="card-header">
                                <h4 style="margin: 0;">üìù Formulario de Solicitud</h4>
                            </div>
                            <div class="card-body">
                                <form id="solicitarPrestamoForm">
                                    <div class="form-group">
                                        <label for="tipoMaterial">Tipo de Material:</label>
                                        <select id="tipoMaterial" class="form-control" required onchange="BibliotecaSPA.cargarMateriales()">
                                            <option value="">Seleccione el tipo...</option>
                                            <option value="LIBRO">üìö Libro</option>
                                            <option value="ARTICULO_ESPECIAL">üé® Art√≠culo Especial</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="materialSeleccionado">Material:</label>
                                        <select id="materialSeleccionado" class="form-control" required disabled>
                                            <option value="">Primero seleccione el tipo de material</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="bibliotecarioSeleccionado">Bibliotecario Responsable:</label>
                                        <select id="bibliotecarioSeleccionado" class="form-control" required>
                                            <option value="">Cargando bibliotecarios...</option>
                                        </select>
                                        <small class="form-text text-muted">Seleccione el bibliotecario que gestionar√° su pr√©stamo</small>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="fechaDevolucion">Fecha de Devoluci√≥n Deseada:</label>
                                        <input type="date" id="fechaDevolucion" class="form-control" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="motivoPrestamo">Motivo del Pr√©stamo (opcional):</label>
                                        <textarea id="motivoPrestamo" class="form-control" rows="3" 
                                                  placeholder="Explique brevemente el motivo del pr√©stamo..."></textarea>
                                    </div>
                                    
                                    <div class="form-group text-center">
                                        <button type="submit" class="btn btn-success btn-lg">
                                            üìñ Solicitar Pr√©stamo
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-4">
                        <div class="card">
                            <div class="card-header">
                                <h4 style="margin: 0;">‚ÑπÔ∏è Informaci√≥n</h4>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info">
                                    <strong>üìã Reglas de Pr√©stamo:</strong>
                                    <ul style="margin: 10px 0; padding-left: 20px;">
                                        <li>M√°ximo 3 pr√©stamos activos</li>
                                        <li>Duraci√≥n m√°xima: 30 d√≠as</li>
                                        <li>Renovaci√≥n autom√°tica disponible</li>
                                        <li>Multas por devoluci√≥n tard√≠a</li>
                                    </ul>
                                </div>
                                
                                <div class="alert alert-warning">
                                    <strong>‚ö†Ô∏è Estado Actual:</strong>
                                    <p>Pr√©stamos activos: <span id="prestamosActivosCount">-</span></p>
                                    <p>L√≠mite: 3 pr√©stamos</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Crear nueva p√°gina
        const pageId = 'solicitarPrestamoPage';
        if ($(`#${pageId}`).length === 0) {
            $('main').append(`<div id="${pageId}" class="page" style="display: none;"></div>`);
        }
        
        $(`#${pageId}`).html(content);
        this.showPage('solicitarPrestamo');
        this.setupSolicitarPrestamoForm();
        this.cargarPrestamosActivos();
    },
    
    // Configurar formulario de solicitar pr√©stamo
    setupSolicitarPrestamoForm: function() {
        $('#solicitarPrestamoForm').on('submit', (e) => {
            e.preventDefault();
            this.procesarSolicitudPrestamo();
        });
        
        // Establecer fecha m√≠nima (hoy)
        const today = new Date();
        $('#fechaDevolucion').attr('min', today.toISOString().split('T')[0]);
        
        // Cargar bibliotecarios disponibles
        this.cargarBibliotecarios();
    },
    
    // Cargar materiales seg√∫n el tipo seleccionado
    cargarMateriales: function() {
        const tipo = $('#tipoMaterial').val();
        const select = $('#materialSeleccionado');
        
        if (!tipo) {
            select.prop('disabled', true).html('<option value="">Primero seleccione el tipo de material</option>');
            return;
        }
        
        select.prop('disabled', false);
        select.html('<option value="">Cargando materiales...</option>');
        
        // Intentar cargar del backend primero, luego usar datos simulados como fallback
        const loadPromise = tipo === 'LIBRO' ? 
            this.getLibrosDisponiblesFromBackend() : 
            this.getArticulosDisponiblesFromBackend();
        
        loadPromise.then(materiales => {
            // Usar datos del backend
            let options = '<option value="">Seleccione un material...</option>';
            materiales.forEach(material => {
                const titulo = material.titulo || material.descripcion;
                options += `<option value="${material.id}">${titulo}</option>`;
            });
            
            select.html(options);
        }).catch(error => {
            console.warn('Error al cargar materiales del backend, usando datos simulados:', error);
            
            // Fallback a datos simulados
            const materiales = tipo === 'LIBRO' ? this.getLibrosDisponibles() : this.getArticulosDisponibles();
            
            let options = '<option value="">Seleccione un material...</option>';
            materiales.forEach(material => {
                options += `<option value="${material.id}">${material.titulo}</option>`;
            });
            
            select.html(options);
        });
    },
    
    // Cargar bibliotecarios disponibles
    cargarBibliotecarios: function() {
        const select = $('#bibliotecarioSeleccionado');
        
        select.html('<option value="">Cargando bibliotecarios...</option>');
        
        // Obtener bibliotecarios del backend
        $.ajax({
            url: this.config.apiBaseUrl + '/bibliotecario/lista',
            method: 'GET',
            dataType: 'json',
            success: function(response) {
                console.log('üìã Bibliotecarios recibidos:', response);
                
                if (response.success && response.bibliotecarios && response.bibliotecarios.length > 0) {
                    let options = '<option value="">Seleccione un bibliotecario...</option>';
                    response.bibliotecarios.forEach(bib => {
                        options += `<option value="${bib.id}">${bib.nombre} - ${bib.numeroEmpleado}</option>`;
                    });
                    select.html(options);
                } else {
                    // Si no hay bibliotecarios disponibles, usar el primero como default
                    select.html('<option value="1">Bibliotecario Predeterminado</option>');
                    console.warn('‚ö†Ô∏è No hay bibliotecarios disponibles, usando default');
                }
            },
            error: function(xhr, status, error) {
                console.error('‚ùå Error al cargar bibliotecarios:', error);
                // Usar bibliotecario por defecto si falla
                select.html('<option value="1">Bibliotecario Predeterminado</option>');
            }
        });
    },
    
    // Obtener libros disponibles (fallback cuando el backend no est√° disponible)
    getLibrosDisponibles: function() {
        console.log('üîç Getting libros disponibles (fallback - empty for new system)');
        // Retornar array vac√≠o para sistema nuevo sin datos precargados
        return [];
    },
    
    // Obtener libros disponibles del backend
    getLibrosDisponiblesFromBackend: function() {
        return new Promise((resolve, reject) => {
            $.ajax({
                url: this.config.apiBaseUrl + '/donacion/libros',
                method: 'GET',
                dataType: 'json',
                success: function(response) {
                    if (response.success && response.libros) {
                        resolve(response.libros);
                    } else {
                        reject(new Error(response.message || 'Error al obtener libros'));
                    }
                },
                error: function(xhr, status, error) {
                    reject(new Error('Error de conexi√≥n: ' + error));
                }
            });
        });
    },
    
    // Obtener art√≠culos especiales disponibles (fallback cuando el backend no est√° disponible)
    getArticulosDisponibles: function() {
        console.log('üîç Getting articulos disponibles (fallback - empty for new system)');
        // Retornar array vac√≠o para sistema nuevo sin datos precargados
        return [];
    },
    
    // Obtener art√≠culos especiales disponibles del backend
    getArticulosDisponiblesFromBackend: function() {
        return new Promise((resolve, reject) => {
            $.ajax({
                url: this.config.apiBaseUrl + '/donacion/articulos',
                method: 'GET',
                dataType: 'json',
                success: function(response) {
                    if (response.success && response.articulos) {
                        resolve(response.articulos);
                    } else {
                        reject(new Error(response.message || 'Error al obtener art√≠culos especiales'));
                    }
                },
                error: function(xhr, status, error) {
                    reject(new Error('Error de conexi√≥n: ' + error));
                }
            });
        });
    },
    
    // Cargar pr√©stamos activos del usuario
    cargarPrestamosActivos: async function() {
        console.log('üîç cargarPrestamosActivos called');
        
        try {
            // Obtener ID del lector desde la sesi√≥n
            const userSession = this.config.userSession;
            const lectorId = userSession && userSession.userData ? userSession.userData.id : null;
            
            if (!lectorId) {
                console.warn('‚ö†Ô∏è No se pudo obtener el ID del lector de la sesi√≥n');
                $('#prestamosActivosCount').text('0');
                return;
            }
            
            console.log('üìö Obteniendo pr√©stamos activos para lector ID:', lectorId);
            
            // Llamar al endpoint para obtener cantidad de pr√©stamos del lector
            const response = await $.ajax({
                url: `/prestamo/cantidad-por-lector?lectorId=${lectorId}`,
                method: 'GET',
                dataType: 'json'
            });
            
            console.log('üìä Respuesta de pr√©stamos activos:', response);
            
            if (response && response.success) {
                const cantidad = response.cantidad || 0;
                $('#prestamosActivosCount').text(cantidad);
                console.log('‚úÖ Pr√©stamos activos cargados:', cantidad);
            } else {
                $('#prestamosActivosCount').text('0');
            }
            
        } catch (error) {
            console.error('‚ùå Error al cargar pr√©stamos activos:', error);
            $('#prestamosActivosCount').text('0');
        }
    },
    
    // Procesar solicitud de pr√©stamo
    procesarSolicitudPrestamo: async function() {
        console.log('üìù procesarSolicitudPrestamo iniciado');
        
        const formData = {
            tipoMaterial: $('#tipoMaterial').val(),
            materialId: $('#materialSeleccionado').val(),
            bibliotecarioId: $('#bibliotecarioSeleccionado').val(),
            fechaDevolucion: $('#fechaDevolucion').val(),
            motivo: $('#motivoPrestamo').val()
        };
        
        console.log('üìù Datos del formulario:', formData);
        
        if (!this.validarSolicitudPrestamo(formData)) {
            console.log('‚ùå Validaci√≥n de formulario fall√≥');
            return;
        }
        
        // Obtener ID del lector desde la sesi√≥n
        const userSession = this.config.userSession;
        const lectorId = userSession && userSession.userData ? userSession.userData.id : null;
        
        console.log('üë§ Lector ID desde sesi√≥n:', lectorId);
        console.log('üë®‚Äçüíº Bibliotecario ID:', formData.bibliotecarioId);
        
        if (!lectorId) {
            this.showAlert('Error: No se pudo identificar al usuario. Por favor, vuelva a iniciar sesi√≥n.', 'danger');
            return;
        }
        
        if (!formData.bibliotecarioId) {
            this.showAlert('Error: Debe seleccionar un bibliotecario responsable.', 'danger');
            return;
        }
        
        this.showLoading('Procesando solicitud de pr√©stamo...');
        
        try {
            // Convertir fecha de YYYY-MM-DD a DD/MM/YYYY para el servidor
            const fechaDevolucionFormatted = this.convertDateToServerFormat(formData.fechaDevolucion);
            
            console.log('üìÖ Fecha original:', formData.fechaDevolucion);
            console.log('üìÖ Fecha formateada:', fechaDevolucionFormatted);
            
            // Crear pr√©stamo usando la API
            const response = await BibliotecaAPI.prestamos.create({
                lectorId: lectorId,
                bibliotecarioId: formData.bibliotecarioId,
                materialId: formData.materialId,
                fechaDevolucion: fechaDevolucionFormatted,
                estado: 'EN_CURSO'
            });
            
            console.log('üìä Respuesta crear pr√©stamo:', response);
            
            this.hideLoading();
            
            if (response.success || (response.data && response.data.success)) {
                this.showAlert('¬°Pr√©stamo aprobado y creado exitosamente! Puede ver los detalles en "Mis Pr√©stamos".', 'success');
                
                // Actualizar estad√≠sticas del dashboard
                await this.loadLectorStats();
                
                // Redirigir a "Mis Pr√©stamos" para ver el nuevo pr√©stamo
                setTimeout(() => {
                    this.verMisPrestamos();
                }, 1500);
            } else {
                const message = response.message || (response.data && response.data.message) || 'Error desconocido al crear pr√©stamo';
                this.showAlert('Error al solicitar pr√©stamo: ' + message, 'danger');
            }
        } catch (error) {
            console.error('‚ùå Error al procesar solicitud:', error);
            this.hideLoading();
            this.showAlert('Error al procesar la solicitud: ' + error.message, 'danger');
        }
    },
    
    // Validar solicitud de pr√©stamo
    validarSolicitudPrestamo: function(data) {
        if (!data.tipoMaterial) {
            this.showAlert('Por favor seleccione el tipo de material', 'danger');
            return false;
        }
        
        if (!data.materialId) {
            this.showAlert('Por favor seleccione un material', 'danger');
            return false;
        }
        
        if (!data.bibliotecarioId) {
            this.showAlert('Por favor seleccione un bibliotecario responsable', 'danger');
            return false;
        }
        
        if (!data.fechaDevolucion) {
            this.showAlert('Por favor seleccione la fecha de devoluci√≥n', 'danger');
            return false;
        }
        
        const fechaDevolucion = new Date(data.fechaDevolucion);
        const hoy = new Date();
        const maxFecha = new Date();
        maxFecha.setDate(hoy.getDate() + 30); // M√°ximo 30 d√≠as
        
        if (fechaDevolucion <= hoy) {
            this.showAlert('La fecha de devoluci√≥n debe ser futura', 'danger');
            return false;
        }
        
        if (fechaDevolucion > maxFecha) {
            this.showAlert('La fecha de devoluci√≥n no puede ser mayor a 30 d√≠as', 'danger');
            return false;
        }
        
        return true;
    },
    
    // Ver cat√°logo
    verCatalogo: function() {
        this.showLoading('Cargando cat√°logo...');
        
        setTimeout(() => {
            this.hideLoading();
            this.renderCatalogo();
        }, 1000);
    },
    
    // Renderizar cat√°logo
    renderCatalogo: function() {
        const content = `
            <div class="fade-in-up">
                <h2 class="text-gradient mb-3">üìö Cat√°logo de Libros</h2>
                
                <!-- Filtros de b√∫squeda -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h4 style="margin: 0;">üîç Buscar Libros</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-8">
                                <div class="form-group">
                                    <label for="buscarCatalogo">Buscar:</label>
                                    <input type="text" id="buscarCatalogo" class="form-control" placeholder="Buscar por t√≠tulo o donante..." onkeyup="BibliotecaSPA.buscarCatalogoEnTiempoReal()">
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="form-group">
                                    <label>&nbsp;</label>
                                    <button class="btn btn-secondary" onclick="BibliotecaSPA.limpiarBusquedaCatalogo()" style="width: 100%;">
                                        üîÑ Limpiar B√∫squeda
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Estad√≠sticas del cat√°logo -->
                <div class="stats-grid mb-3">
                    <div class="stat-card">
                        <div class="stat-number" id="totalLibros">0</div>
                        <div class="stat-label">Total de Libros</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="librosMostrados">0</div>
                        <div class="stat-label">Libros Mostrados</div>
                    </div>
                </div>
                
                <!-- Lista de libros -->
                <div class="card">
                    <div class="card-header">
                        <h4 style="margin: 0;">üìñ Listado de Libros</h4>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table" id="catalogoTable">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>T√≠tulo</th>
                                        <th>P√°ginas</th>
                                        <th>Donante</th>
                                        <th>Fecha de Ingreso</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="5" class="text-center">
                                            <div class="spinner"></div>
                                            Cargando cat√°logo...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Crear nueva p√°gina
        const pageId = 'catalogoPage';
        if ($(`#${pageId}`).length === 0) {
            $('main').append(`<div id="${pageId}" class="page" style="display: none;"></div>`);
        }
        
        $(`#${pageId}`).html(content);
        this.showPage('catalogo');
        this.loadCatalogoData();
    },
    
    // Cargar datos del cat√°logo
    loadCatalogoData: async function() {
        console.log('üîç Cargando cat√°logo de libros desde el backend...');
        
        try {
            // Obtener libros desde el API (sin contexto /biblioteca-pap para servidor integrado)
            const response = await $.ajax({
                url: '/donacion/libros',
                method: 'GET',
                dataType: 'json'
            });
            
            console.log('üìö Respuesta del servidor:', response);
            
            if (response && response.success && response.libros) {
                console.log('‚úÖ Libros cargados:', response.libros.length);
                this.todosLosLibros = response.libros;
                this.librosFiltrados = response.libros;
                this.renderCatalogoTable(response.libros);
                this.updateCatalogoStats(response.libros);
            } else {
                console.warn('‚ö†Ô∏è Respuesta sin libros:', response);
                this.todosLosLibros = [];
                this.librosFiltrados = [];
                this.renderCatalogoTable([]);
                this.updateCatalogoStats([]);
            }
        } catch (error) {
            console.error('‚ùå Error cargando datos del cat√°logo:', error);
            $('#catalogoTable tbody').html('<tr><td colspan="5" class="text-center alert alert-danger">Error al cargar el cat√°logo. Por favor, intente nuevamente.<br>Error: ' + error.message + '</td></tr>');
            $('#totalLibros').text('0');
            $('#librosMostrados').text('0');
        }
    },
    
    // Renderizar tabla del cat√°logo
    renderCatalogoTable: function(libros) {
        const tbody = $('#catalogoTable tbody');
        tbody.empty();
        
        if (!libros || libros.length === 0) {
            tbody.html('<tr><td colspan="5" class="text-center">No se encontraron libros en el cat√°logo</td></tr>');
            return;
        }
        
        libros.forEach(libro => {
            const fechaFormateada = this.formatDateSimple(libro.fechaIngreso);
            const row = `
                <tr>
                    <td>${libro.id}</td>
                    <td><strong>${libro.titulo}</strong></td>
                    <td>${libro.paginas}</td>
                    <td>${libro.donante || 'An√≥nimo'}</td>
                    <td>${fechaFormateada}</td>
                </tr>
            `;
            tbody.append(row);
        });
    },
    
    // Actualizar estad√≠sticas del cat√°logo
    updateCatalogoStats: function(libros) {
        const totalMostrados = libros ? libros.length : 0;
        const totalLibros = this.todosLosLibros ? this.todosLosLibros.length : 0;
        
        console.log('üìä Actualizando estad√≠sticas - Mostrando', totalMostrados, 'de', totalLibros, 'libros');
        $('#totalLibros').text(totalLibros);
        $('#librosMostrados').text(totalMostrados);
        
        // Cambiar color si hay filtro activo
        const searchTerm = $('#buscarCatalogo').val().trim();
        if (searchTerm !== '' && totalMostrados < totalLibros) {
            $('#librosMostrados').css('color', '#007bff');
        } else {
            $('#librosMostrados').css('color', '');
        }
    },
    
    // Funciones auxiliares para el cat√°logo
    buscarCatalogo: function() {
        const searchTerm = $('#buscarCatalogo').val().toLowerCase().trim();
        console.log('üîç Buscando:', searchTerm);
        
        if (!this.todosLosLibros || this.todosLosLibros.length === 0) {
            console.warn('‚ö†Ô∏è No hay libros cargados');
            return;
        }
        
        if (searchTerm === '') {
            this.librosFiltrados = this.todosLosLibros;
        } else {
            this.librosFiltrados = this.todosLosLibros.filter(libro => 
                libro.titulo.toLowerCase().includes(searchTerm) ||
                (libro.donante && libro.donante.toLowerCase().includes(searchTerm))
            );
        }
        
        console.log('‚úÖ Libros filtrados:', this.librosFiltrados.length, 'de', this.todosLosLibros.length);
        this.renderCatalogoTable(this.librosFiltrados);
        this.updateCatalogoStats(this.librosFiltrados);
        
        // Mostrar mensaje si no se encontraron resultados
        if (this.librosFiltrados.length === 0 && searchTerm !== '') {
            $('#catalogoTable tbody').html('<tr><td colspan="5" class="text-center text-muted">No se encontraron libros que coincidan con "' + searchTerm + '"</td></tr>');
        }
    },
    
    // B√∫squeda en tiempo real con debounce
    buscarCatalogoEnTiempoReal: function() {
        // Cancelar b√∫squeda anterior si existe
        if (this.searchTimeout) {
            clearTimeout(this.searchTimeout);
        }
        
        // Esperar 300ms despu√©s de que el usuario deje de escribir
        this.searchTimeout = setTimeout(() => {
            this.buscarCatalogo();
        }, 300);
    },
    
    limpiarBusquedaCatalogo: function() {
        console.log('üîÑ Limpiando b√∫squeda');
        $('#buscarCatalogo').val('');
        if (this.todosLosLibros) {
            this.librosFiltrados = this.todosLosLibros;
            this.renderCatalogoTable(this.todosLosLibros);
            this.updateCatalogoStats(this.todosLosLibros);
            console.log('‚úÖ Mostrando todos los libros:', this.todosLosLibros.length);
        }
        // Enfocar de nuevo en el input de b√∫squeda
        $('#buscarCatalogo').focus();
    },
    
    verDetallesLibro: function(id) {
        const libro = this.todosLosLibros ? this.todosLosLibros.find(l => l.id === id) : null;
        
        if (libro) {
            const fechaFormateada = this.formatDateSimple(libro.fechaIngreso);
            const detalles = `
                <div style="text-align: left;">
                    <p><strong>ID:</strong> ${libro.id}</p>
                    <p><strong>T√≠tulo:</strong> ${libro.titulo}</p>
                    <p><strong>P√°ginas:</strong> ${libro.paginas}</p>
                    <p><strong>Donante:</strong> ${libro.donante || 'An√≥nimo'}</p>
                    <p><strong>Fecha de Ingreso:</strong> ${fechaFormateada}</p>
                </div>
            `;
            this.showModal('Detalles del Libro', detalles);
        } else {
            this.showAlert(`No se encontr√≥ el libro con ID: ${id}`, 'warning');
        }
    },
    
    // Funci√≥n auxiliar para formatear fechas
    formatDateSimple: function(dateString) {
        if (!dateString) return '-';
        
        try {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        } catch (error) {
            return dateString;
        }
    },
    
    verDetallesPrestamo: function(id) {
        this.showAlert(`Ver detalles del pr√©stamo ID: ${id}`, 'info');
    },
    
    renovarPrestamo: function(id) {
        this.showAlert(`Renovar pr√©stamo ID: ${id}`, 'info');
    },
    
    aplicarFiltrosPrestamos: function() {
        console.log('üîç Aplicando filtros a mis pr√©stamos...');
        
        // Obtener valores de los filtros
        const estadoFiltro = $('#estadoFilterPrestamos').val();
        const tipoFiltro = $('#tipoMaterialFilter').val();
        
        console.log('üìã Filtros seleccionados:', { estado: estadoFiltro, tipo: tipoFiltro });
        
        // Obtener todos los pr√©stamos originales
        const todosLosPrestamos = this.config.allPrestamos || [];
        
        if (todosLosPrestamos.length === 0) {
            console.warn('‚ö†Ô∏è No hay pr√©stamos para filtrar');
            this.showAlert('No hay pr√©stamos para filtrar', 'warning');
            return;
        }
        
        // Aplicar filtros
        let prestamosFiltrados = todosLosPrestamos.filter(prestamo => {
            let cumpleFiltros = true;
            
            // Filtro por estado
            if (estadoFiltro && estadoFiltro !== '') {
                cumpleFiltros = cumpleFiltros && prestamo.estado === estadoFiltro;
            }
            
            // Filtro por tipo
            if (tipoFiltro && tipoFiltro !== '') {
                cumpleFiltros = cumpleFiltros && prestamo.tipo === tipoFiltro;
            }
            
            return cumpleFiltros;
        });
        
        console.log(`‚úÖ ${prestamosFiltrados.length} de ${todosLosPrestamos.length} pr√©stamos despu√©s de filtrar`);
        
        // Actualizar la tabla con los pr√©stamos filtrados
        this.renderMisPrestamosTable(prestamosFiltrados);
        this.updateMisPrestamosStats(prestamosFiltrados);
        
        // Mostrar mensaje de resultado
        if (prestamosFiltrados.length === 0) {
            this.showAlert('No se encontraron pr√©stamos con los filtros seleccionados', 'info');
        } else {
            this.showAlert(`Se encontraron ${prestamosFiltrados.length} pr√©stamo(s)`, 'success');
        }
    },
    
    // Limpiar filtros de pr√©stamos
    limpiarFiltrosPrestamos: function() {
        console.log('üîÑ Limpiando filtros...');
        
        // Resetear los selectores
        $('#estadoFilterPrestamos').val('');
        $('#tipoMaterialFilter').val('');
        
        // Mostrar todos los pr√©stamos
        const todosLosPrestamos = this.config.allPrestamos || [];
        this.renderMisPrestamosTable(todosLosPrestamos);
        this.updateMisPrestamosStats(todosLosPrestamos);
        
        this.showAlert('Filtros limpiados', 'info');
    },
    
    // Manejo de temas
    initTheme: function() {
        const savedTheme = localStorage.getItem('biblioteca-theme') || 'light';
        this.setTheme(savedTheme);
    },
    
    setTheme: function(theme) {
        const body = document.body;
        const themeToggle = $('#themeToggle');
        const icon = themeToggle.find('i');
        
        if (theme === 'dark') {
            body.setAttribute('data-theme', 'dark');
            icon.removeClass('fa-moon').addClass('fa-sun');
            themeToggle.addClass('active');
        } else {
            body.removeAttribute('data-theme');
            icon.removeClass('fa-sun').addClass('fa-moon');
            themeToggle.removeClass('active');
        }
        
        localStorage.setItem('biblioteca-theme', theme);
    },
    
    toggleTheme: function() {
        const currentTheme = document.body.getAttribute('data-theme') || 'light';
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        this.setTheme(newTheme);
        
        // Mostrar notificaci√≥n
        this.showAlert(`Tema cambiado a ${newTheme === 'dark' ? 'oscuro' : 'claro'}`, 'info');
    },
    
    // ==================== FUNCIONES PARA BOTONES DE SERVICIOS ====================
    
    // Mi Historial - Nueva funcionalidad
    verMiHistorial: function() {
        this.renderMiHistorial();
    },
    
    // Renderizar p√°gina de Mi Historial
    renderMiHistorial: function() {
        const html = `
            <div class="page-header">
                <h2>üìã Mi Historial</h2>
                <p>Historial completo de todos mis pr√©stamos y actividades</p>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üìö</div>
                    <div class="stat-content">
                        <h3 id="totalPrestamosHistorial">0</h3>
                        <p>Total Pr√©stamos</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-content">
                        <h3 id="prestamosCompletadosHistorial">0</h3>
                        <p>Completados</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚è≥</div>
                    <div class="stat-content">
                        <h3 id="prestamosPendientesHistorial">0</h3>
                        <p>Pendientes</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìÖ</div>
                    <div class="stat-content">
                        <h3 id="diasPromedioHistorial">0</h3>
                        <p>D√≠as Promedio</p>
                    </div>
                </div>
            </div>
            
            <div class="content-section">
                <div class="section-header">
                    <h3>üìä Filtros</h3>
                    <div class="filter-controls">
                        <select id="filtroHistorial" class="form-control">
                            <option value="todos">Todos los pr√©stamos</option>
                            <option value="completados">Solo completados</option>
                            <option value="pendientes">Solo pendientes</option>
                            <option value="vencidos">Solo vencidos</option>
                            <option value="ultimo-mes">√öltimo mes</option>
                            <option value="ultimo-ano">√öltimo a√±o</option>
                        </select>
                        <button class="btn btn-primary" onclick="BibliotecaSPA.aplicarFiltrosHistorial()">
                            üîç Aplicar Filtros
                        </button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table class="data-table" id="historialTable">
                        <thead>
                            <tr>
                                <th>üìö Material</th>
                                <th>üìÖ Fecha Solicitud</th>
                                <th>üìÖ Fecha Devoluci√≥n</th>
                                <th>‚è±Ô∏è Duraci√≥n</th>
                                <th>üìä Estado</th>
                                <th>üë§ Bibliotecario</th>
                                <th>üìù Observaciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Los datos se cargar√°n din√°micamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        `;
        
        $('#mainContent').html(html);
        this.loadHistorialData();
    },
    
    // Cargar datos del historial
    loadHistorialData: function() {
        // Simular datos del historial
        const historialData = [
            {
                id: 1,
                material: 'El Quijote de la Mancha',
                fechaSolicitud: '2024-01-15',
                fechaDevolucion: '2024-01-30',
                duracion: '15 d√≠as',
                estado: 'COMPLETADO',
                bibliotecario: 'Ana Garc√≠a',
                observaciones: 'Devoluci√≥n a tiempo'
            },
            {
                id: 2,
                material: '1984 - George Orwell',
                fechaSolicitud: '2024-02-01',
                fechaDevolucion: '2024-02-15',
                duracion: '14 d√≠as',
                estado: 'COMPLETADO',
                bibliotecario: 'Carlos L√≥pez',
                observaciones: 'Excelente estado'
            },
            {
                id: 3,
                material: 'Historia del Arte',
                fechaSolicitud: '2024-02-20',
                fechaDevolucion: null,
                duracion: 'En curso',
                estado: 'EN_CURSO',
                bibliotecario: 'Mar√≠a Rodr√≠guez',
                observaciones: 'Pr√©stamo activo'
            },
            {
                id: 4,
                material: 'F√≠sica Cu√°ntica',
                fechaSolicitud: '2024-01-10',
                fechaDevolucion: '2024-01-25',
                duracion: '15 d√≠as',
                estado: 'COMPLETADO',
                bibliotecario: 'Ana Garc√≠a',
                observaciones: 'Devoluci√≥n puntual'
            }
        ];
        
        this.renderHistorialTable(historialData);
        this.updateHistorialStats(historialData);
    },
    
    // Renderizar tabla del historial
    renderHistorialTable: function(data) {
        const tbody = $('#historialTable tbody');
        tbody.empty();
        
        data.forEach(prestamo => {
            const row = `
                <tr>
                    <td>${prestamo.material}</td>
                    <td>${prestamo.fechaSolicitud}</td>
                    <td>${prestamo.fechaDevolucion || 'En curso'}</td>
                    <td>${prestamo.duracion}</td>
                    <td>${this.getEstadoBadge(prestamo.estado)}</td>
                    <td>${prestamo.bibliotecario}</td>
                    <td>${prestamo.observaciones}</td>
                </tr>
            `;
            tbody.append(row);
        });
    },
    
    // Actualizar estad√≠sticas del historial
    updateHistorialStats: function(data) {
        const total = data.length;
        const completados = data.filter(p => p.estado === 'COMPLETADO').length;
        const pendientes = data.filter(p => p.estado === 'EN_CURSO').length;
        const diasPromedio = data.filter(p => p.estado === 'COMPLETADO').length > 0 ? 
            Math.round(data.filter(p => p.estado === 'COMPLETADO').reduce((acc, p) => {
                const dias = Math.ceil((new Date(p.fechaDevolucion) - new Date(p.fechaSolicitud)) / (1000 * 60 * 60 * 24));
                return acc + dias;
            }, 0) / data.filter(p => p.estado === 'COMPLETADO').length) : 0;
        
        $('#totalPrestamosHistorial').text(total);
        $('#prestamosCompletadosHistorial').text(completados);
        $('#prestamosPendientesHistorial').text(pendientes);
        $('#diasPromedioHistorial').text(diasPromedio);
    },
    
    // Aplicar filtros al historial
    aplicarFiltrosHistorial: function() {
        const filtro = $('#filtroHistorial').val();
        const tbody = $('#historialTable tbody');
        
        tbody.find('tr').each(function() {
            const row = $(this);
            const estado = row.find('.badge').text().toLowerCase();
            const fechaSolicitud = row.find('td:nth-child(2)').text();
            
            let mostrar = true;
            
            switch(filtro) {
                case 'completados':
                    mostrar = estado.includes('completado');
                    break;
                case 'pendientes':
                    mostrar = estado.includes('en curso');
                    break;
                case 'vencidos':
                    mostrar = estado.includes('vencido');
                    break;
                case 'ultimo-mes':
                    const fecha = new Date(fechaSolicitud);
                    const haceUnMes = new Date();
                    haceUnMes.setMonth(haceUnMes.getMonth() - 1);
                    mostrar = fecha >= haceUnMes;
                    break;
                case 'ultimo-ano':
                    const fechaAno = new Date(fechaSolicitud);
                    const haceUnAno = new Date();
                    haceUnAno.setFullYear(haceUnAno.getFullYear() - 1);
                    mostrar = fechaAno >= haceUnAno;
                    break;
            }
            
            if (mostrar) {
                row.show();
            } else {
                row.hide();
            }
        });
    },
    
    // Buscar Libros - Redirigir a Ver Cat√°logo
    buscarLibros: function() {
        this.verCatalogo();
    },
    
    // Buscar Materiales - Redirigir a Ver Cat√°logo
    buscarMateriales: function() {
        this.verCatalogo();
    }
};

// Inicializar cuando el DOM est√© listo
$(document).ready(function() {
    BibliotecaSPA.init();
});

// Hacer disponible globalmente
window.BibliotecaSPA = BibliotecaSPA;
