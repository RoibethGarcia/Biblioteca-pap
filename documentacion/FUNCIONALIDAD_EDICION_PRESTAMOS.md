# ‚úÖ FUNCIONALIDAD IMPLEMENTADA: Edici√≥n Completa de Pr√©stamos

## üìã RESUMEN

Se implement√≥ la funcionalidad completa para que los bibliotecarios puedan **editar/actualizar cualquier informaci√≥n de un pr√©stamo**, incluyendo:
- Lector asignado
- Bibliotecario responsable
- Material prestado
- Fecha de devoluci√≥n
- Estado del pr√©stamo

---

## üéØ FUNCIONALIDAD

### **Descripci√≥n**:
Permite a los bibliotecarios modificar cualquier aspecto de un pr√©stamo existente a trav√©s de una interfaz visual intuitiva.

### **Campos editables**:
- ‚úèÔ∏è **Lector**: Cambiar el lector asociado al pr√©stamo
- ‚úèÔ∏è **Bibliotecario**: Cambiar el bibliotecario responsable
- ‚úèÔ∏è **Material**: Cambiar el libro o art√≠culo prestado
- ‚úèÔ∏è **Fecha de Devoluci√≥n**: Modificar la fecha estimada de devoluci√≥n
- ‚úèÔ∏è **Estado**: Cambiar entre PENDIENTE, EN_CURSO o DEVUELTO

---

## üîß IMPLEMENTACI√ìN BACKEND

### **1. PrestamoService.java** ‚úÖ YA EXIST√çA

**Archivo**: `src/main/java/edu/udelar/pap/service/PrestamoService.java`  
**M√©todo**: `actualizarPrestamoCompleto()` (l√≠neas 448-488)

```java
public boolean actualizarPrestamoCompleto(Long prestamoId, Lector nuevoLector, 
                                        Bibliotecario nuevoBibliotecario, 
                                        Object nuevoMaterial,
                                        LocalDate nuevaFechaEstimadaDevolucion, 
                                        EstadoPrestamo nuevoEstado) {
    try (Session session = sessionFactory.openSession()) {
        Transaction tx = session.beginTransaction();
        try {
            Prestamo prestamo = session.get(Prestamo.class, prestamoId);
            if (prestamo == null) {
                tx.rollback();
                return false;
            }
            
            // Actualizar solo los campos que no sean null
            if (nuevoLector != null) {
                prestamo.setLector(nuevoLector);
            }
            if (nuevoBibliotecario != null) {
                prestamo.setBibliotecario(nuevoBibliotecario);
            }
            if (nuevoMaterial != null) {
                prestamo.setMaterial((DonacionMaterial) nuevoMaterial);
            }
            if (nuevaFechaEstimadaDevolucion != null) {
                prestamo.setFechaEstimadaDevolucion(nuevaFechaEstimadaDevolucion);
            }
            if (nuevoEstado != null) {
                prestamo.setEstado(nuevoEstado);
            }
            
            session.merge(prestamo);
            tx.commit();
            return true;
        }
    }
}
```

**Caracter√≠stica**: Actualiza solo los campos que no sean `null`, permitiendo actualizaciones parciales.

---

### **2. PrestamoControllerUltraRefactored.java** ‚úÖ NUEVO

**Archivo**: `src/main/java/edu/udelar/pap/controller/PrestamoControllerUltraRefactored.java`  
**M√©todo**: `actualizarPrestamoWeb()` (l√≠neas 1884-1971)

```java
public boolean actualizarPrestamoWeb(Long prestamoId, Long lectorId, Long bibliotecarioId, 
                                    Long materialId, String fechaDevolucion, String estado) 
                                    throws IllegalStateException {
    // Obtener entidades si se proporcionaron IDs
    Lector nuevoLector = null;
    if (lectorId != null) {
        nuevoLector = lectorService.obtenerLectorPorId(lectorId);
        if (nuevoLector == null) {
            throw new IllegalStateException("Lector no encontrado con ID: " + lectorId);
        }
    }
    
    // Similar para bibliotecario, material...
    
    LocalDate nuevaFecha = null;
    if (fechaDevolucion != null && !fechaDevolucion.trim().isEmpty()) {
        nuevaFecha = ValidacionesUtil.validarFechaFutura(fechaDevolucion);
    }
    
    EstadoPrestamo nuevoEstado = null;
    if (estado != null && !estado.trim().isEmpty()) {
        nuevoEstado = EstadoPrestamo.valueOf(estado.toUpperCase());
    }
    
    // Actualizar el pr√©stamo
    boolean resultado = prestamoService.actualizarPrestamoCompleto(
        prestamoId, nuevoLector, nuevoBibliotecario, nuevoMaterial, nuevaFecha, nuevoEstado
    );
    
    return resultado;
}
```

**Validaciones**:
- ‚úÖ Verifica que las entidades (lector, bibliotecario, material) existan
- ‚úÖ Valida formato de fecha (DD/MM/YYYY)
- ‚úÖ Valida que el estado sea v√°lido
- ‚úÖ Permite par√°metros opcionales (null = no cambiar)

---

### **3. PrestamoPublisher.java** ‚úÖ NUEVO

**Archivo**: `src/main/java/edu/udelar/pap/publisher/PrestamoPublisher.java`  
**M√©todo**: `actualizarPrestamo()` (l√≠neas 321-375)

```java
public String actualizarPrestamo(String prestamoIdStr, String lectorIdStr, 
                                String bibliotecarioIdStr, String materialIdStr, 
                                String fechaDevolucion, String estado) {
    try {
        // Validar que el ID del pr√©stamo est√© presente
        if (prestamoIdStr == null || prestamoIdStr.trim().isEmpty()) {
            return "{\"success\": false, \"message\": \"El ID del pr√©stamo es requerido\"}";
        }
        
        Long prestamoId = Long.parseLong(prestamoIdStr);
        
        // Parsear IDs opcionales (null si est√°n vac√≠os)
        Long lectorId = (lectorIdStr != null && !lectorIdStr.trim().isEmpty()) ? 
            Long.parseLong(lectorIdStr) : null;
        Long bibliotecarioId = (bibliotecarioIdStr != null && !bibliotecarioIdStr.trim().isEmpty()) ? 
            Long.parseLong(bibliotecarioIdStr) : null;
        Long materialId = (materialIdStr != null && !materialIdStr.trim().isEmpty()) ? 
            Long.parseLong(materialIdStr) : null;
        
        boolean resultado = prestamoController.actualizarPrestamoWeb(
            prestamoId, lectorId, bibliotecarioId, materialId, fechaDevolucion, estado
        );
        
        if (resultado) {
            return "{\"success\": true, \"message\": \"Pr√©stamo actualizado exitosamente\"}";
        } else {
            return "{\"success\": false, \"message\": \"No se pudo actualizar el pr√©stamo\"}";
        }
        
    } catch (IllegalStateException e) {
        return String.format("{\"success\": false, \"message\": \"%s\"}", 
            e.getMessage().replace("\"", "\\\""));
    } catch (Exception e) {
        return String.format("{\"success\": false, \"message\": \"Error al actualizar: %s\"}", 
            e.getMessage().replace("\"", "\\\""));
    }
}
```

---

### **4. IntegratedServer.java** ‚úÖ NUEVO

**Archivo**: `src/main/java/edu/udelar/pap/server/IntegratedServer.java`  
**L√≠neas**: 615-647

```java
} else if (path.equals("/prestamo/actualizar") && method.equals("POST")) {
    // ‚ú® NUEVO: Actualizar pr√©stamo completo
    String body = new String(exchange.getRequestBody().readAllBytes(), "UTF-8");
    
    Map<String, String> params = new HashMap<>();
    for (String param : body.split("&")) {
        String[] keyValue = param.split("=");
        if (keyValue.length == 2) {
            params.put(URLDecoder.decode(keyValue[0], "UTF-8"), 
                      URLDecoder.decode(keyValue[1], "UTF-8"));
        }
    }
    
    String prestamoIdStr = params.get("prestamoId");
    String lectorIdStr = params.get("lectorId");
    String bibliotecarioIdStr = params.get("bibliotecarioId");
    String materialIdStr = params.get("materialId");
    String fechaDevolucion = params.get("fechaDevolucion");
    String estado = params.get("estado");
    
    if (prestamoIdStr == null || prestamoIdStr.trim().isEmpty()) {
        return "{\"success\": false, \"message\": \"El ID del pr√©stamo es requerido\"}";
    }
    
    return factory.getPrestamoPublisher().actualizarPrestamo(
        prestamoIdStr, lectorIdStr, bibliotecarioIdStr, materialIdStr, fechaDevolucion, estado
    );
}
```

---

### **5. PrestamoServlet.java** ‚úÖ NUEVO

**Archivo**: `src/main/java/edu/udelar/pap/servlet/PrestamoServlet.java`  
**L√≠neas**: 155-173

```java
} else if (pathInfo.equals("/actualizar")) {
    // ‚ú® NUEVO: Actualizar pr√©stamo completo
    String prestamoId = request.getParameter("prestamoId");
    String lectorId = request.getParameter("lectorId");
    String bibliotecarioId = request.getParameter("bibliotecarioId");
    String materialId = request.getParameter("materialId");
    String fechaDevolucion = request.getParameter("fechaDevolucion");
    String estado = request.getParameter("estado");
    
    if (prestamoId == null) {
        response.setStatus(HttpServletResponse.SC_BAD_REQUEST);
        out.println("{\"error\": \"prestamoId es requerido\"}");
        return;
    }
    
    String result = factory.getPrestamoPublisher().actualizarPrestamo(
        prestamoId, lectorId, bibliotecarioId, materialId, fechaDevolucion, estado
    );
    out.println(result);
}
```

---

## üé® IMPLEMENTACI√ìN FRONTEND

### **1. Bot√≥n "Editar" en tabla** ‚úÖ NUEVO

**Archivo**: `src/main/webapp/js/spa.js`  
**Funci√≥n**: `renderPrestamosGestionTable()` (l√≠neas 1326-1340)

Se agreg√≥ el bot√≥n "‚úèÔ∏è Editar" en la columna de acciones:

```javascript
{ field: 'acciones', header: 'Acciones', width: '360px',
  render: (p) => `
    <button class="btn btn-primary btn-sm" onclick="BibliotecaSPA.verDetallesPrestamo(${p.id})">
        üëÅÔ∏è Ver
    </button>
    <button class="btn btn-info btn-sm" onclick="BibliotecaSPA.editarPrestamo(${p.id})">
        ‚úèÔ∏è Editar
    </button>
    <button class="btn btn-success btn-sm" onclick="BibliotecaSPA.procesarDevolucion(${p.id})">
        ‚Ü©Ô∏è Devolver
    </button>
    <button class="btn btn-warning btn-sm" onclick="BibliotecaSPA.renovarPrestamo(${p.id})">
        üîÑ Renovar
    </button>
  `}
```

---

### **2. Modal de edici√≥n** ‚úÖ NUEVO

**Archivo**: `src/main/webapp/js/spa.js`  
**Funci√≥n**: `editarPrestamo()` (l√≠neas 1458-1574)

```javascript
editarPrestamo: async function(idPrestamo) {
    try {
        // Obtener datos actuales del pr√©stamo
        const data = await bibliotecaApi.prestamos.info(idPrestamo);
        const prestamo = data.prestamo || data;
        
        // Cargar listas de lectores, bibliotecarios y materiales
        const lectoresData = await bibliotecaApi.lectores.lista();
        const bibliotecarioData = await bibliotecaApi.bibliotecarios.lista();
        const librosData = await bibliotecaApi.donaciones.libros();
        const articulosData = await bibliotecaApi.donaciones.articulos();
        
        // Crear opciones para los selects con valores pre-seleccionados
        const lectoresOptions = lectores.map(l => 
            `<option value="${l.id}" ${l.id == prestamo.lectorId ? 'selected' : ''}>
                ${l.nombre} (ID: ${l.id})
            </option>`
        ).join('');
        
        // Similar para bibliotecarios y materiales...
        
        // Mostrar modal con formulario pre-llenado
        ModalManager.show({
            title: '‚úèÔ∏è Editar Pr√©stamo #' + idPrestamo,
            body: `<form>...</form>`,
            footer: `<button onclick="BibliotecaSPA.guardarEdicionPrestamo(${idPrestamo})">
                üíæ Guardar Cambios
            </button>`
        });
    }
}
```

**Caracter√≠sticas del modal**:
- ‚úÖ Carga datos actuales del pr√©stamo
- ‚úÖ Pre-selecciona valores actuales en los select
- ‚úÖ Muestra todas las opciones disponibles
- ‚úÖ Validaci√≥n de campos requeridos
- ‚úÖ Conversi√≥n autom√°tica de formatos de fecha

---

### **3. Funci√≥n para guardar cambios** ‚úÖ NUEVO

**Archivo**: `src/main/webapp/js/spa.js`  
**Funci√≥n**: `guardarEdicionPrestamo()` (l√≠neas 1576-1634)

```javascript
guardarEdicionPrestamo: async function(idPrestamo) {
    try {
        // Obtener valores del formulario
        const lectorId = $('#editLectorId').val();
        const bibliotecarioId = $('#editBibliotecarioId').val();
        const materialId = $('#editMaterialId').val();
        const fechaDevolucion = $('#editFechaDevolucion').val();
        const estado = $('#editEstado').val();
        
        // Validar campos requeridos
        if (!lectorId || !bibliotecarioId || !materialId || !fechaDevolucion || !estado) {
            this.showAlert('‚ö†Ô∏è Todos los campos son obligatorios', 'warning');
            return;
        }
        
        // Convertir fecha de YYYY-MM-DD a DD/MM/YYYY
        const fechaFormatted = this.convertDateToServerFormat(fechaDevolucion);
        
        // Preparar datos
        const params = new URLSearchParams();
        params.append('prestamoId', idPrestamo);
        params.append('lectorId', lectorId);
        params.append('bibliotecarioId', bibliotecarioId);
        params.append('materialId', materialId);
        params.append('fechaDevolucion', fechaFormatted);
        params.append('estado', estado);
        
        // Enviar petici√≥n
        const response = await bibliotecaApi.post('/prestamo/actualizar', params);
        
        if (response && response.success) {
            this.showAlert('‚úÖ Pr√©stamo actualizado exitosamente', 'success');
            ModalManager.close('modal-edit-prestamo-' + idPrestamo);
            
            // Recargar tabla
            this.loadPrestamosGestionData();
        } else {
            this.showAlert('Error: ' + (response.message || 'Error desconocido'), 'danger');
        }
    } catch (error) {
        this.showAlert('Error al guardar cambios: ' + error.message, 'danger');
    }
}
```

---

## üìä ENDPOINT CREADO

### **URL**: `POST /prestamo/actualizar`

### **Par√°metros** (todos opcionales excepto prestamoId):
- `prestamoId` (Long, **requerido**): ID del pr√©stamo a actualizar
- `lectorId` (Long, opcional): Nuevo ID del lector
- `bibliotecarioId` (Long, opcional): Nuevo ID del bibliotecario
- `materialId` (Long, opcional): Nuevo ID del material
- `fechaDevolucion` (String DD/MM/YYYY, opcional): Nueva fecha de devoluci√≥n
- `estado` (String, opcional): Nuevo estado (PENDIENTE, EN_CURSO, DEVUELTO)

### **Ejemplo de uso**:
```javascript
POST /prestamo/actualizar
Body: prestamoId=5&lectorId=10&fechaDevolucion=15/02/2024&estado=EN_CURSO
```

### **Respuesta exitosa**:
```json
{
  "success": true,
  "message": "Pr√©stamo actualizado exitosamente"
}
```

### **Respuesta con error**:
```json
{
  "success": false,
  "message": "Lector no encontrado con ID: 999"
}
```

---

## üéØ FLUJO DE USO

### **Paso 1: Acceder a la funci√≥n**
1. Login como **bibliotecario**
2. Ir a **"Gesti√≥n de Pr√©stamos"**
3. En la tabla, localizar el pr√©stamo a editar
4. Hacer clic en el bot√≥n **"‚úèÔ∏è Editar"**

### **Paso 2: Editar datos**
1. Se abre un modal con el formulario pre-llenado
2. Modificar los campos deseados:
   - Cambiar lector (dropdown con todos los lectores)
   - Cambiar bibliotecario (dropdown con todos los bibliotecarios)
   - Cambiar material (dropdown con libros y art√≠culos)
   - Modificar fecha de devoluci√≥n (selector de fecha)
   - Cambiar estado (dropdown: PENDIENTE, EN_CURSO, DEVUELTO)

### **Paso 3: Guardar cambios**
1. Hacer clic en **"üíæ Guardar Cambios"**
2. El sistema valida los datos
3. Env√≠a la petici√≥n al backend
4. Muestra mensaje de √©xito o error
5. Cierra el modal autom√°ticamente si fue exitoso
6. Recarga la tabla con los datos actualizados

### **Paso 4: Verificar cambios**
1. La tabla se actualiza autom√°ticamente
2. Los cambios son visibles de inmediato
3. Se puede ver el pr√©stamo modificado en la tabla

---

## üìã VALIDACIONES IMPLEMENTADAS

### **Frontend**:
1. ‚úÖ Todos los campos son obligatorios
2. ‚úÖ Conversi√≥n correcta de formato de fecha
3. ‚úÖ Validaci√≥n antes de enviar

### **Backend**:
1. ‚úÖ prestamoId es obligatorio
2. ‚úÖ Verifica que el pr√©stamo existe
3. ‚úÖ Verifica que lector existe (si se proporciona)
4. ‚úÖ Verifica que bibliotecario existe (si se proporciona)
5. ‚úÖ Verifica que material existe (si se proporciona)
6. ‚úÖ Valida formato de fecha DD/MM/YYYY
7. ‚úÖ Valida que el estado sea v√°lido
8. ‚úÖ Manejo de errores con mensajes descriptivos

---

## üß™ CASOS DE PRUEBA

### **Test 1: Cambiar lector del pr√©stamo**
1. Abrir modal de edici√≥n
2. Seleccionar un lector diferente
3. Guardar cambios
4. ‚úÖ Verificar que el pr√©stamo ahora aparece con el nuevo lector

### **Test 2: Cambiar estado de PENDIENTE a EN_CURSO**
1. Localizar un pr√©stamo PENDIENTE
2. Editar y cambiar estado a EN_CURSO
3. Guardar
4. ‚úÖ El badge de estado debe actualizarse

### **Test 3: Extender fecha de devoluci√≥n**
1. Editar un pr√©stamo
2. Cambiar la fecha de devoluci√≥n a una futura
3. Guardar
4. ‚úÖ La nueva fecha debe mostrarse en la tabla

### **Test 4: Cambiar material prestado**
1. Editar un pr√©stamo
2. Seleccionar un material diferente
3. Guardar
4. ‚úÖ La columna "Material" debe mostrar el nuevo material

### **Test 5: Validaci√≥n de datos inv√°lidos**
1. Intentar guardar con campos vac√≠os
2. ‚úÖ Debe mostrar error: "Todos los campos son obligatorios"

### **Test 6: Lector inexistente**
1. Manualmente llamar al endpoint con lectorId=999999
2. ‚úÖ Debe devolver error: "Lector no encontrado con ID: 999999"

---

## üìä ARCHIVOS MODIFICADOS

| Archivo | L√≠neas | Tipo de Cambio |
|---------|--------|----------------|
| `PrestamoService.java` | 448-488 | ‚úÖ Ya exist√≠a |
| `PrestamoControllerUltraRefactored.java` | 1884-1971 | ‚ú® Nuevo m√©todo |
| `PrestamoPublisher.java` | 321-375 | ‚ú® Nuevo m√©todo |
| `IntegratedServer.java` | 615-647 | ‚ú® Nuevo endpoint |
| `PrestamoServlet.java` | 51, 155-173 | ‚ú® Nuevo endpoint |
| `spa.js` - Bot√≥n | 1326-1340 | üîß Columna acciones ampliada |
| `spa.js` - Modal | 1458-1574 | ‚ú® Nueva funci√≥n editarPrestamo() |
| `spa.js` - Guardar | 1576-1634 | ‚ú® Nueva funci√≥n guardarEdicionPrestamo() |

---

## ‚ö†Ô∏è IMPORTANTE: REINICIAR SERVIDOR

Para que los cambios en el backend surtan efecto:

```bash
# Detener servidor (Ctrl+C)
# Recompilar
mvn clean compile
# Reiniciar servidor
mvn exec:java -Dexec.mainClass="edu.udelar.pap.server.IntegratedServer"
```

**Para cambios en el frontend**:
- Simplemente **refrescar el navegador** (F5)

---

## üéØ RESULTADO VISUAL

### **Tabla de Gesti√≥n de Pr√©stamos**:

**Columna de Acciones antes**:
```
üëÅÔ∏è Ver | ‚Ü©Ô∏è Devolver | üîÑ Renovar
```

**Columna de Acciones despu√©s**:
```
üëÅÔ∏è Ver | ‚úèÔ∏è Editar | ‚Ü©Ô∏è Devolver | üîÑ Renovar
```

### **Modal de Edici√≥n**:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ‚úèÔ∏è Editar Pr√©stamo #5                   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Lector: *           [Juan P√©rez ‚ñº]      ‚îÇ
‚îÇ Bibliotecario: *    [Mar√≠a Garc√≠a ‚ñº]    ‚îÇ
‚îÇ Material: *         [[LIBRO] Don Quijote ‚ñº] ‚îÇ
‚îÇ Fecha Devoluci√≥n: * [15/02/2024]        ‚îÇ
‚îÇ Estado: *           [En Curso ‚ñº]        ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ ‚ÑπÔ∏è Puede modificar cualquier campo     ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ [Cancelar]  [üíæ Guardar Cambios]       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üìà ACTUALIZACI√ìN DEL PROGRESO

**Funcionalidades CORE**: 100% ‚úÖ (13/13)  
**Funcionalidades OPCIONALES**: 50% ‚úÖ (2/4)  
**Progreso TOTAL**: 88% ‚úÖ (15/17)

### **Funcionalidades opcionales**:
- ‚úÖ Consulta de donaciones por rango de fechas
- ‚úÖ **Edici√≥n completa de pr√©stamos**
- ‚ùå Historial de pr√©stamos por bibliotecario
- ‚ùå Reporte de pr√©stamos por zona

---

## üìÖ FECHA DE IMPLEMENTACI√ìN

**Fecha**: 11 de octubre de 2025  
**Estado**: ‚úÖ **COMPLETADO**  
**Progreso**: Segunda funcionalidad opcional implementada (2/4)
