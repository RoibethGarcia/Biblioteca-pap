# Funcionalidad: Materiales con Muchos Pr√©stamos Pendientes

## üìã Descripci√≥n del Caso de Uso

**OPCIONAL**: Como bibliotecario, quiero identificar materiales con muchos pr√©stamos pendientes para priorizar su devoluci√≥n o reposici√≥n.

## ‚úÖ Estado: IMPLEMENTADO

Fecha: 11 de Octubre, 2025

## üéØ Caracter√≠sticas Implementadas

### 1. Bot√≥n "Ver Materiales Pendientes" en Reportes
- **Ubicaci√≥n**: Secci√≥n "Reportes", primera fila, primera tarjeta
- **Icono**: üì¶ + üî•
- **Color**: Rojo (danger) para indicar urgencia
- **Funcionalidad**: Muestra materiales ordenados por cantidad de pr√©stamos activos

### 2. Modal de Materiales Pendientes
El modal muestra:
- **Estad√≠sticas generales** (header con gradiente rosa-rojo):
  - Total de materiales con pr√©stamos
  - Total de pr√©stamos activos
  - Materiales con prioridad ALTA (üî¥)
  - Materiales con prioridad MEDIA (üü°)
  - Materiales con prioridad BAJA (üü¢)

### 3. Tabla de Materiales Ordenada
Columnas:
- **#**: Posici√≥n en el ranking
- **Material**: Nombre del libro o art√≠culo
- **Tipo**: LIBRO o ARTICULO
- **Pendientes**: Cantidad de pr√©stamos con estado PENDIENTE
- **En Curso**: Cantidad de pr√©stamos con estado EN_CURSO
- **Total**: Suma de pendientes + en curso
- **Prioridad**: ALTA (‚â•5), MEDIA (3-4), BAJA (1-2)

### 4. Sistema de Prioridades
- **üî¥ ALTA** (‚â•5 pr√©stamos):
  - Fondo de fila: Rojo claro (#ffebee)
  - Badge: Rojo (badge-danger)
  - Acci√≥n: Priorizar devoluci√≥n inmediata
  
- **üü° MEDIA** (3-4 pr√©stamos):
  - Fondo de fila: Amarillo claro (#fff3e0)
  - Badge: Amarillo (badge-warning)
  - Acci√≥n: Monitorear y considerar reposici√≥n
  
- **üü¢ BAJA** (1-2 pr√©stamos):
  - Fondo de fila: Blanco
  - Badge: Verde (badge-success)
  - Acci√≥n: Seguimiento normal

### 5. Filtros
- **Filtro por prioridad**:
  - Todas
  - üî¥ Alta (‚â•5 pr√©stamos)
  - üü° Media (3-4 pr√©stamos)
  - üü¢ Baja (1-2 pr√©stamos)
- **Bot√≥n limpiar**: Restaura vista completa

### 6. Exportaci√≥n a CSV
- Bot√≥n "üì• Exportar a CSV"
- Incluye:
  - Datos completos de todos los materiales
  - Columna de recomendaciones
  - Resumen con estad√≠sticas
  - Fecha en el nombre del archivo

## üîß Componentes Creados/Modificados

### Backend (Java)

#### 1. `/src/main/java/edu/udelar/pap/publisher/PrestamoPublisher.java`

**M√©todo nuevo** (l√≠neas 352-460):
```java
public String obtenerMaterialesPendientes() {
    try {
        // Obtener materiales con pr√©stamos PENDIENTES
        List<Object[]> resultadosPendientes = prestamoController.obtenerMaterialesConPrestamosPendientes();
        
        // Obtener materiales con pr√©stamos EN_CURSO
        List<Prestamo> todosLosPrestamos = prestamoController.obtenerTodosPrestamos();
        Map<Object, Integer> materialesEnCurso = new HashMap<>();
        
        // Agrupar por material
        for (Prestamo p : todosLosPrestamos) {
            if (p.getEstado() == EstadoPrestamo.EN_CURSO && p.getMaterial() != null) {
                materialesEnCurso.put(p.getMaterial(), materialesEnCurso.getOrDefault(p.getMaterial(), 0) + 1);
            }
        }
        
        // Consolidar informaci√≥n
        Map<Long, MaterialPendienteInfo> materialesMap = new HashMap<>();
        
        // Procesar y ordenar
        List<MaterialPendienteInfo> materialesOrdenados = new ArrayList<>(materialesMap.values());
        materialesOrdenados.sort((a, b) -> Integer.compare(b.getTotal(), a.getTotal()));
        
        // Construir JSON con prioridades
        // ALTA: total >= 5
        // MEDIA: total >= 3
        // BAJA: total < 3
        
        return json.toString();
    } catch (Exception e) {
        return String.format("{\"success\": false, \"message\": \"Error: %s\"}", e.getMessage());
    }
}

// Clase auxiliar
private static class MaterialPendienteInfo {
    DonacionMaterial material;
    int pendientes = 0;
    int enCurso = 0;
    
    int getTotal() {
        return pendientes + enCurso;
    }
}
```

**Caracter√≠sticas del m√©todo**:
- Combina pr√©stamos PENDIENTES y EN_CURSO
- Agrupa por material (evita duplicados)
- Calcula totales y asigna prioridades
- Ordena de mayor a menor por total
- Distingue entre LIBRO y ARTICULO

#### 2. `/src/main/java/edu/udelar/pap/controller/PrestamoControllerUltraRefactored.java`

**M√©todo nuevo** (l√≠neas 2095-2102):
```java
public List<Object[]> obtenerMaterialesConPrestamosPendientes() {
    try {
        return prestamoService.obtenerMaterialesConPrestamosPendientes();
    } catch (Exception ex) {
        return new ArrayList<>();
    }
}
```

#### 3. `/src/main/java/edu/udelar/pap/server/IntegratedServer.java`

**Handler nuevo** (l√≠neas 599-602):
```java
} else if (path.equals("/prestamo/materiales-pendientes")) {
    System.out.println("üì¶ Obteniendo materiales con pr√©stamos pendientes");
    return factory.getPrestamoPublisher().obtenerMaterialesPendientes();
}
```

#### 4. `/src/main/java/edu/udelar/pap/servlet/PrestamoServlet.java`

**Endpoint nuevo** (l√≠neas 124-127):
```java
} else if (pathInfo.equals("/materiales-pendientes")) {
    String result = factory.getPrestamoPublisher().obtenerMaterialesPendientes();
    out.println(result);
}
```

### Frontend (JavaScript)

#### 1. `/src/main/webapp/js/spa.js`

**Bot√≥n agregado en Reportes** (l√≠neas 2508-2520):
```javascript
<div class="card">
    <div class="card-header">
        <h4 style="margin: 0;">üì¶ Materiales Pendientes</h4>
    </div>
    <div class="card-body">
        <p>Identificar materiales con muchos pr√©stamos para priorizar su devoluci√≥n o reposici√≥n</p>
        <button class="btn btn-danger" onclick="BibliotecaSPA.mostrarMaterialesPendientes()">
            üî• Ver Materiales Pendientes
        </button>
    </div>
</div>
```

**Funciones nuevas**:

1. `mostrarMaterialesPendientes()` (l√≠nea 2962)
   - Llama al endpoint `/prestamo/materiales-pendientes`
   - Muestra modal con los datos
   - Maneja caso de 0 materiales con mensaje positivo

2. `mostrarModalMaterialesPendientes(materiales)` (l√≠nea 2998)
   - Crea modal con estad√≠sticas
   - Muestra tabla de materiales
   - Configura filtro por prioridad
   - Incluye bot√≥n de exportaci√≥n

3. `renderTablaMaterialesPendientes(materiales)` (l√≠nea 3104)
   - Renderiza tabla ordenada
   - Aplica colores de fondo seg√∫n prioridad
   - Muestra badges con estad√≠sticas
   - Numera posiciones

4. `aplicarFiltroMaterialesPendientes()` (l√≠nea 3155)
   - Filtra materiales por prioridad seleccionada
   - Actualiza tabla din√°micamente

5. `limpiarFiltroMaterialesPendientes()` (l√≠nea 3171)
   - Limpia filtro
   - Muestra todos los materiales

6. `exportarMaterialesPendientes()` (l√≠nea 3179)
   - Genera CSV con datos completos
   - Incluye columna de recomendaciones
   - Agrega resumen estad√≠stico

## üìä Formato de Respuesta del Endpoint

### GET `/prestamo/materiales-pendientes`

**Respuesta exitosa**:
```json
{
  "success": true,
  "materiales": [
    {
      "id": 15,
      "nombre": "Don Quijote de la Mancha",
      "tipo": "LIBRO",
      "pendientes": 3,
      "enCurso": 4,
      "total": 7,
      "prioridad": "ALTA"
    },
    {
      "id": 8,
      "nombre": "Cien A√±os de Soledad",
      "tipo": "LIBRO",
      "pendientes": 2,
      "enCurso": 1,
      "total": 3,
      "prioridad": "MEDIA"
    },
    {
      "id": 22,
      "nombre": "Revista National Geographic - Ed. Especial",
      "tipo": "ARTICULO",
      "pendientes": 1,
      "enCurso": 1,
      "total": 2,
      "prioridad": "BAJA"
    }
  ]
}
```

**Respuesta sin materiales**:
```json
{
  "success": true,
  "materiales": []
}
```

## üé® Estilos y UX

### Colores Sem√°nticos
- **Header gradiente**: Rosa-rojo (#f093fb ‚Üí #f5576c)
- **Prioridad ALTA**: Fondo rojo claro, badge rojo
- **Prioridad MEDIA**: Fondo amarillo claro, badge amarillo
- **Prioridad BAJA**: Sin fondo, badge verde

### Badges
| Elemento | Color | Clase |
|----------|-------|-------|
| Material pendientes | Amarillo | `badge-warning` |
| Material en curso | Verde | `badge-success` |
| Total | Azul | `badge-primary` |
| Prioridad ALTA | Rojo | `badge-danger` |
| Prioridad MEDIA | Amarillo | `badge-warning` |
| Prioridad BAJA | Verde | `badge-success` |
| Tipo (LIBRO/ARTICULO) | Cyan | `badge-info` |

## üß™ Instrucciones de Prueba

### Prerrequisitos
1. El servidor debe estar ejecut√°ndose
2. Tener materiales con pr√©stamos pendientes o en curso

### Pasos para Probar

1. **Acceder a la aplicaci√≥n web**:
   ```
   http://localhost:8080/spa.html
   ```

2. **Iniciar sesi√≥n como bibliotecario**:
   - Usuario: `admin@biblioteca.com`
   - Contrase√±a: `admin123`

3. **Navegar a Reportes**:
   - Hacer clic en "üìä Reportes" en el men√∫ lateral izquierdo

4. **Ver Materiales Pendientes**:
   - Hacer clic en el bot√≥n "üî• Ver Materiales Pendientes"
   - Verificar que se abre el modal

5. **Verificar el modal**:
   - **Estad√≠sticas**: Verificar n√∫meros en el header
   - **Tabla**: Verificar que muestra materiales ordenados
   - **Colores**: Filas con prioridad ALTA deben tener fondo rojo claro

6. **Probar filtro por prioridad**:
   - Seleccionar "üî¥ Alta"
   - Verificar que solo se muestran materiales con prioridad ALTA
   - Seleccionar "üü° Media"
   - Verificar que solo se muestran materiales con prioridad MEDIA
   - Hacer clic en "üîÑ Limpiar"
   - Verificar que se muestran todos los materiales

7. **Verificar ordenamiento**:
   - Los materiales deben estar ordenados de mayor a menor por total
   - El material #1 debe tener el mayor n√∫mero de pr√©stamos

8. **Exportar a CSV**:
   - Hacer clic en "üì• Exportar a CSV"
   - Verificar que se descarga el archivo
   - Abrir el CSV y verificar:
     - Columnas: Posici√≥n, Material, Tipo, Pendientes, En Curso, Total, Prioridad, Recomendaci√≥n
     - Resumen al final con estad√≠sticas

9. **Cerrar modal**:
   - Hacer clic en "Cerrar"
   - Verificar que el modal se cierra correctamente

### Casos de Prueba Espec√≠ficos

#### Test 1: Sin materiales pendientes
- **Acci√≥n**: Ver materiales cuando no hay pr√©stamos activos
- **Resultado esperado**: Mensaje "¬°Excelente! No hay materiales con pr√©stamos pendientes en este momento"

#### Test 2: Materiales con prioridad ALTA
- **Acci√≥n**: Verificar material con ‚â•5 pr√©stamos
- **Resultado esperado**: 
  - Fila con fondo rojo claro
  - Badge rojo "üî¥ ALTA"
  - Total ‚â• 5

#### Test 3: Filtro por prioridad
- **Acci√≥n**: Aplicar filtro "Alta"
- **Resultado esperado**: Solo materiales con total ‚â• 5

#### Test 4: Verificar suma de estados
- **Acci√≥n**: Para cada material, sumar Pendientes + En Curso
- **Resultado esperado**: Debe ser igual a Total

#### Test 5: CSV con recomendaciones
- **Acci√≥n**: Exportar y revisar columna "Recomendaci√≥n"
- **Resultado esperado**: 
  - ALTA: "Priorizar devoluci√≥n inmediata"
  - MEDIA: "Monitorear y considerar reposici√≥n"
  - BAJA: "Seguimiento normal"

## üîç Casos de Uso del Reporte

### 1. Identificar Materiales Populares
**Pregunta**: ¬øQu√© materiales son m√°s solicitados?
**Respuesta**: Los materiales al inicio de la lista (mayor total)

### 2. Priorizar Devoluciones
**Pregunta**: ¬øQu√© materiales necesito recuperar urgentemente?
**Respuesta**: Materiales con prioridad ALTA (fondo rojo)

### 3. Decisiones de Reposici√≥n
**Pregunta**: ¬øQu√© materiales deber√≠a adquirir m√°s copias?
**Respuesta**: Materiales con prioridad ALTA o MEDIA constantemente

### 4. Seguimiento de Demanda
**Pregunta**: ¬øHay materiales con demanda insatisfecha?
**Respuesta**: Materiales con muchos pendientes indica alta demanda

### 5. Gesti√≥n de Inventario
**Pregunta**: ¬øQu√© materiales est√°n saturados?
**Respuesta**: Materiales con total alto necesitan m√°s atenci√≥n

## üí° Ventajas de la Implementaci√≥n

1. ‚úÖ **Identificaci√≥n r√°pida**: Vista consolidada de materiales m√°s solicitados
2. ‚úÖ **Sistema de prioridades**: Clasificaci√≥n autom√°tica en ALTA/MEDIA/BAJA
3. ‚úÖ **Colores visuales**: Filas con fondo de color seg√∫n urgencia
4. ‚úÖ **Ordenamiento inteligente**: De mayor a menor demanda
5. ‚úÖ **Combina estados**: Considera tanto PENDIENTE como EN_CURSO
6. ‚úÖ **Estad√≠sticas claras**: N√∫meros grandes y f√°ciles de interpretar
7. ‚úÖ **Exportable**: CSV con recomendaciones para cada material
8. ‚úÖ **Filtros √∫tiles**: Enfocarse solo en prioridades espec√≠ficas
9. ‚úÖ **Accionable**: Recomendaciones claras en el CSV
10. ‚úÖ **Sin configuraci√≥n**: Funciona autom√°ticamente al hacer clic

## üìù Notas T√©cnicas

### Backend
- Usa `PrestamoService.obtenerMaterialesConPrestamosPendientes()` para estado PENDIENTE
- Complementa con an√°lisis de todos los pr√©stamos para estado EN_CURSO
- Agrupa por material usando un `HashMap` con ID del material como key
- Calcula prioridades basadas en totales: ‚â•5 (ALTA), ‚â•3 (MEDIA), <3 (BAJA)
- Ordena en el backend antes de enviar al frontend

### Frontend
- Guarda datos en `this.materialesPendientesActual` para filtrado local
- Renderizado din√°mico de filas con estilos condicionales
- Filtro sin necesidad de re-fetch (usa datos en memoria)
- CSV incluye columna calculada de "Recomendaci√≥n"

### L√≥gica de Prioridades
```javascript
ALTA:   total >= 5  ‚Üí "Priorizar devoluci√≥n inmediata"
MEDIA:  total >= 3  ‚Üí "Monitorear y considerar reposici√≥n"
BAJA:   total < 3   ‚Üí "Seguimiento normal"
```

## üìä Interpretaci√≥n del Reporte

### Material con Prioridad ALTA
```
Material: "Don Quijote de la Mancha"
Pendientes: 3, En Curso: 4, Total: 7
Prioridad: ALTA
```
**Interpretaci√≥n**: 
- Este material tiene 7 pr√©stamos activos
- Es muy popular y solicitado
- **Acci√≥n recomendada**: 
  1. Contactar a lectores para priorizar devoluci√≥n
  2. Considerar adquirir m√°s copias
  3. Crear lista de espera si hay m√°s solicitudes

### Material con Prioridad MEDIA
```
Material: "Cien A√±os de Soledad"
Pendientes: 1, En Curso: 2, Total: 3
Prioridad: MEDIA
```
**Interpretaci√≥n**:
- Demanda moderada
- **Acci√≥n recomendada**:
  1. Monitorear si aumenta la demanda
  2. Considerar reposici√≥n si se mantiene constante

### Material con Prioridad BAJA
```
Material: "Revista National Geographic"
Pendientes: 0, En Curso: 1, Total: 1
Prioridad: BAJA
```
**Interpretaci√≥n**:
- Demanda normal
- **Acci√≥n recomendada**: Seguimiento rutinario

## üöÄ Mejoras Futuras (Opcionales)

- [ ] Agregar gr√°fico de barras para top 10 materiales
- [ ] Mostrar tendencia (comparar con semana/mes anterior)
- [ ] Agregar lista de espera para materiales saturados
- [ ] Notificaciones autom√°ticas cuando un material alcanza prioridad ALTA
- [ ] Integraci√≥n con sistema de adquisiciones para reposici√≥n
- [ ] Mostrar tiempo promedio de devoluci√≥n por material
- [ ] Agregar filtro por tipo de material (LIBRO/ARTICULO)
- [ ] Incluir informaci√≥n del donante original
- [ ] Mostrar disponibilidad actual del material
- [ ] Agregar drill-down: clic en material para ver pr√©stamos espec√≠ficos

## ‚úÖ Resultado

El bibliotecario puede identificar r√°pidamente qu√© materiales tienen muchos pr√©stamos activos, priorizarlos seg√∫n el nivel de urgencia (ALTA/MEDIA/BAJA), y tomar decisiones informadas sobre:
- Priorizaci√≥n de devoluciones
- Reposici√≥n de materiales populares
- Gesti√≥n de demanda
- Planificaci√≥n de adquisiciones

